# Vercelçµ±åˆå‹ å®Œå…¨å®Ÿè£…ã‚¬ã‚¤ãƒ‰
## ã‚ªãƒ¼ãƒ—ãƒ³ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹ç”³è¾¼ + AIè‡ªå‹•å¿œç­”ã®çµ±åˆ

---

## ğŸ“‹ ç›®æ¬¡

1. [ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦](#ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦)
2. [å‰ææ¡ä»¶](#å‰ææ¡ä»¶)
3. [OpenAI APIã‚­ãƒ¼å–å¾—](#openai-apiã‚­ãƒ¼å–å¾—)
4. [ç’°å¢ƒå¤‰æ•°è¨­å®š](#ç’°å¢ƒå¤‰æ•°è¨­å®š)
5. [ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«](#ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«)
6. [ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ](#ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ)
7. [å®Ÿè£…ã‚³ãƒ¼ãƒ‰](#å®Ÿè£…ã‚³ãƒ¼ãƒ‰)
8. [ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †](#ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †)
9. [å‹•ä½œç¢ºèª](#å‹•ä½œç¢ºèª)
10. [ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°](#ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°)

---

## ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦

### æ©Ÿèƒ½

1. **ã‚ªãƒ¼ãƒ—ãƒ³ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹ç”³è¾¼é€£æº**
   - Webç”³è¾¼ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ç”³è¾¼
   - LINEå‹é”è¿½åŠ ã§è‡ªå‹•é€£æº
   - ç”³è¾¼å®Œäº†é€šçŸ¥

2. **AIè‡ªå‹•å¿œç­”ï¼ˆChatGPTï¼‰**
   - ã‚ˆãã‚ã‚‹è³ªå•ã«24æ™‚é–“è‡ªå‹•å›ç­”
   - å­¦æ ¡æƒ…å ±ã‚’å­¦ç¿’ã—ãŸAI
   - è‡ªç„¶ãªä¼šè©±å½¢å¼

### ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆå›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆç”Ÿå¾’ãƒ»ä¿è­·è€…ï¼‰             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                     â”‚
    ã€ç”³è¾¼ã€‘                ã€è³ªå•ã€‘
         â”‚                     â”‚
         â–¼                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”³è¾¼ãƒ•ã‚©ãƒ¼ãƒ     â”‚    â”‚ LINE ãƒˆãƒ¼ã‚¯  â”‚
â”‚  (Next.js)      â”‚    â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
         â”‚                     â”‚
         â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚    â”‚
         â–¼    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Vercel (Next.js App)              â”‚
â”‚                                           â”‚
â”‚  /api/line/webhook â† LINE Webhook        â”‚
â”‚         â†“                                 â”‚
â”‚   ã‚¤ãƒ™ãƒ³ãƒˆæŒ¯ã‚Šåˆ†ã‘                         â”‚
â”‚         â†“                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚  â”‚             â”‚                        â”‚
â”‚  â–¼             â–¼                        â”‚
â”‚ follow      message                     â”‚
â”‚  â”‚             â”‚                        â”‚
â”‚  â–¼             â–¼                        â”‚
â”‚ ç”³è¾¼é€£æº    AIå¿œç­”                       â”‚
â”‚  â†“             â†“                        â”‚
â”‚ Supabase   OpenAI API                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å‰ææ¡ä»¶

### å¿…è¦ãªã‚¢ã‚«ã‚¦ãƒ³ãƒˆ

- âœ… Vercel ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ
- âœ… Supabase ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ
- âœ… LINE Developers ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ
- âœ… OpenAI ã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼ˆæ–°è¦ï¼‰

### æ—¢å­˜ã®è¨­å®š

- âœ… Next.jsãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆæ¸ˆã¿
- âœ… Supabaseãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­å®šæ¸ˆã¿
- âœ… LINEå…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆæ¸ˆã¿
- âœ… åŸºæœ¬çš„ãªã‚ªãƒ¼ãƒ—ãƒ³ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹ç”³è¾¼æ©Ÿèƒ½å®Ÿè£…æ¸ˆã¿

---

## OpenAI APIã‚­ãƒ¼å–å¾—

### ã‚¹ãƒ†ãƒƒãƒ—1: OpenAIã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ

1. https://platform.openai.com/signup ã«ã‚¢ã‚¯ã‚»ã‚¹
2. ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ç™»éŒ²
3. é›»è©±ç•ªå·èªè¨¼ï¼ˆSMSï¼‰

### ã‚¹ãƒ†ãƒƒãƒ—2: APIã‚­ãƒ¼ä½œæˆ

1. ãƒ­ã‚°ã‚¤ãƒ³å¾Œã€å·¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã€ŒAPI keysã€ã‚’é¸æŠ
2. ã€ŒCreate new secret keyã€ã‚’ã‚¯ãƒªãƒƒã‚¯
3. åå‰ã‚’å…¥åŠ›ï¼ˆä¾‹: opencampus-systemï¼‰
4. ã€ŒCreate secret keyã€ã‚’ã‚¯ãƒªãƒƒã‚¯
5. **è¡¨ç¤ºã•ã‚ŒãŸã‚­ãƒ¼ã‚’å¿…ãšã‚³ãƒ”ãƒ¼ã—ã¦ä¿å­˜**ï¼ˆå†è¡¨ç¤ºä¸å¯ï¼‰

```
ä¾‹: sk-proj-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

### ã‚¹ãƒ†ãƒƒãƒ—3: ä½¿ç”¨é‡åˆ¶é™è¨­å®šï¼ˆæ¨å¥¨ï¼‰

1. ã€ŒSettingsã€â†’ã€ŒLimitsã€
2. ã€ŒUsage limitsã€ã§æœˆé¡ä¸Šé™ã‚’è¨­å®š
   - æ¨å¥¨: $10/æœˆï¼ˆç´„Â¥1,500ï¼‰
   - ã“ã‚Œã§æœˆé–“æ•°ä¸‡å›ã®åˆ©ç”¨ãŒå¯èƒ½

### ã‚¹ãƒ†ãƒƒãƒ—4: æ”¯æ‰•ã„æ–¹æ³•ç™»éŒ²

1. ã€ŒSettingsã€â†’ã€ŒBillingã€
2. ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰æƒ…å ±ã‚’ç™»éŒ²
3. æœ€ä½$5ï¼ˆç´„Â¥750ï¼‰ã®ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆè³¼å…¥

**é‡è¦: æ”¯æ‰•ã„æ–¹æ³•ã‚’ç™»éŒ²ã—ãªã„ã¨APIãŒä½¿ãˆã¾ã›ã‚“**

---

## ç’°å¢ƒå¤‰æ•°è¨­å®š

### ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç”¨ï¼ˆ.env.localï¼‰

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã« `.env.local` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ:

```bash
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://xxxxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# LINE Messaging API
LINE_CHANNEL_ACCESS_TOKEN=your-channel-access-token
LINE_CHANNEL_SECRET=your-channel-secret

# OpenAI APIï¼ˆæ–°è¦è¿½åŠ ï¼‰
OPENAI_API_KEY=sk-proj-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
OPENAI_MODEL=gpt-4o-mini
OPENAI_MAX_TOKENS=500
OPENAI_TEMPERATURE=0.7

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š
NEXT_PUBLIC_APP_URL=http://localhost:3000
```

### æœ¬ç•ªç’°å¢ƒç”¨ï¼ˆVercelï¼‰

Vercelãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§è¨­å®š:

1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠ
2. ã€ŒSettingsã€â†’ã€ŒEnvironment Variablesã€
3. ä»¥ä¸‹ã‚’è¿½åŠ :

| Name | Value | Environment |
|------|-------|-------------|
| NEXT_PUBLIC_SUPABASE_URL | https://xxxxx.supabase.co | Production |
| NEXT_PUBLIC_SUPABASE_ANON_KEY | eyJhbGci... | Production |
| SUPABASE_SERVICE_ROLE_KEY | eyJhbGci... | Production |
| LINE_CHANNEL_ACCESS_TOKEN | your-token | Production |
| LINE_CHANNEL_SECRET | your-secret | Production |
| OPENAI_API_KEY | sk-proj-xxx... | Production |
| OPENAI_MODEL | gpt-4o-mini | Production |
| OPENAI_MAX_TOKENS | 500 | Production |
| OPENAI_TEMPERATURE | 0.7 | Production |
| NEXT_PUBLIC_APP_URL | https://your-app.vercel.app | Production |

---

## ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

### å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸

```bash
# OpenAI SDK
npm install openai

# LINE Bot SDKï¼ˆæ—¢å­˜ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰
npm install @line/bot-sdk

# æ—¢å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸
npm install @supabase/supabase-js
npm install zod
```

### package.json ç¢ºèª

```json
{
  "dependencies": {
    "@line/bot-sdk": "^9.5.0",
    "@supabase/supabase-js": "^2.39.0",
    "next": "14.x",
    "openai": "^4.70.0",
    "react": "^18.x",
    "zod": "^3.22.4"
  }
}
```

---

## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

### æ–°è¦ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆï¼ˆä¼šè©±å±¥æ­´ç”¨ï¼‰

Supabaseãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ â†’ SQL Editor ã§å®Ÿè¡Œ:

```sql
-- ä¼šè©±å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE conversation_history (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  line_user_id VARCHAR(100) NOT NULL,
  role VARCHAR(20) NOT NULL CHECK (role IN ('user', 'assistant', 'system')),
  message TEXT NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆï¼ˆæ¤œç´¢é«˜é€ŸåŒ–ï¼‰
CREATE INDEX idx_conversation_history_line_user_id 
ON conversation_history(line_user_id);

CREATE INDEX idx_conversation_history_created_at 
ON conversation_history(created_at DESC);

-- RLSï¼ˆRow Level Securityï¼‰è¨­å®š
ALTER TABLE conversation_history ENABLE ROW LEVEL SECURITY;

-- ã‚µãƒ¼ãƒ“ã‚¹ãƒ­ãƒ¼ãƒ«ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
CREATE POLICY "Service role only" 
ON conversation_history 
FOR ALL 
USING (auth.role() = 'service_role');

-- å¤ã„ä¼šè©±å±¥æ­´ã‚’è‡ªå‹•å‰Šé™¤ã™ã‚‹é–¢æ•°ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
CREATE OR REPLACE FUNCTION delete_old_conversations()
RETURNS void AS $$
BEGIN
  DELETE FROM conversation_history
  WHERE created_at < NOW() - INTERVAL '30 days';
END;
$$ LANGUAGE plpgsql;

-- æ¯æ—¥å®Ÿè¡Œã™ã‚‹ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­å®šï¼ˆSupabase Cronï¼‰
-- Dashboard â†’ Database â†’ Cron Jobs ã‹ã‚‰è¨­å®š
```

### æ—¢å­˜ãƒ†ãƒ¼ãƒ–ãƒ«ã®ç¢ºèª

`applicants` ãƒ†ãƒ¼ãƒ–ãƒ«ã«å¿…è¦ãªã‚«ãƒ©ãƒ ãŒã‚ã‚‹ã‹ç¢ºèª:

```sql
-- å¿…è¦ãªã‚«ãƒ©ãƒ 
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'applicants';

-- ä¸è¶³ã—ã¦ã„ã‚‹å ´åˆã¯è¿½åŠ 
ALTER TABLE applicants ADD COLUMN IF NOT EXISTS line_user_id VARCHAR(100);
ALTER TABLE applicants ADD COLUMN IF NOT EXISTS token VARCHAR(100);
ALTER TABLE applicants ADD COLUMN IF NOT EXISTS token_expires_at TIMESTAMP WITH TIME ZONE;
ALTER TABLE applicants ADD COLUMN IF NOT EXISTS status VARCHAR(50) DEFAULT 'pending';
```

---

## å®Ÿè£…ã‚³ãƒ¼ãƒ‰

### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

```
open-campus-system/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ apply/
â”‚   â”‚   â”‚   â””â”€â”€ route.ts          # ç”³è¾¼APIï¼ˆæ—¢å­˜ï¼‰
â”‚   â”‚   â””â”€â”€ line/
â”‚   â”‚       â””â”€â”€ webhook/
â”‚   â”‚           â””â”€â”€ route.ts       # LINE Webhookï¼ˆçµ±åˆç‰ˆï¼‰
â”‚   â”œâ”€â”€ apply/
â”‚   â”‚   â””â”€â”€ page.tsx               # ç”³è¾¼ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆæ—¢å­˜ï¼‰
â”‚   â””â”€â”€ layout.tsx
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ supabase.ts                # Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆæ—¢å­˜ï¼‰
â”‚   â”œâ”€â”€ ai-response.ts             # AIå¿œç­”ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆæ–°è¦ï¼‰
â”‚   â”œâ”€â”€ conversation-history.ts    # ä¼šè©±å±¥æ­´ç®¡ç†ï¼ˆæ–°è¦ï¼‰
â”‚   â”œâ”€â”€ school-knowledge.ts        # å­¦æ ¡æƒ…å ±ï¼ˆæ–°è¦ï¼‰
â”‚   â””â”€â”€ line-client.ts             # LINEã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆæ—¢å­˜ï¼‰
â”œâ”€â”€ .env.local
â””â”€â”€ package.json
```

---

### 1. å­¦æ ¡æƒ…å ±ã®å®šç¾©

`lib/school-knowledge.ts`:

```typescript
/**
 * å­¦æ ¡æƒ…å ±ã®ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿
 * AIå¿œç­”ã«ä½¿ç”¨ã•ã‚Œã‚‹å­¦æ ¡ã®åŸºæœ¬æƒ…å ±
 */

export const schoolKnowledge = `
ã€å­¦æ ¡åŸºæœ¬æƒ…å ±ã€‘
å­¦æ ¡å: â—‹â—‹é«˜ç­‰å­¦æ ¡ï¼ˆã¾ãŸã¯å°‚é–€å­¦æ ¡ï¼‰
æ‰€åœ¨åœ°: ã€’123-4567 æ±äº¬éƒ½â—‹â—‹åŒºâ–³â–³1-2-3
é›»è©±ç•ªå·: 03-XXXX-XXXX
å—ä»˜æ™‚é–“: å¹³æ—¥ 9:00-17:00
å…¬å¼ã‚µã‚¤ãƒˆ: https://www.example-school.jp

ã€ã‚¢ã‚¯ã‚»ã‚¹ã€‘
æœ€å¯„ã‚Šé§…:
- JRå±±æ‰‹ç·šã€Œæ¸‹è°·é§…ã€ã‹ã‚‰å¾’æ­©10åˆ†
- æ±äº¬ãƒ¡ãƒˆãƒ­éŠ€åº§ç·šã€Œè¡¨å‚é“é§…ã€ã‹ã‚‰å¾’æ­©8åˆ†
- æ±æ€¥ç”°åœ’éƒ½å¸‚ç·šã€Œæ¸‹è°·é§…ã€ã‹ã‚‰å¾’æ­©10åˆ†

ãƒã‚¹ã§ã®ã‚¢ã‚¯ã‚»ã‚¹:
- éƒ½ãƒã‚¹01ç³»çµ±ã€Œâ—‹â—‹å‰ã€ä¸‹è»Šã™ã

é§è»Šå ´: ãªã—ï¼ˆå…¬å…±äº¤é€šæ©Ÿé–¢ã‚’ã”åˆ©ç”¨ãã ã•ã„ï¼‰

ã€ã‚ªãƒ¼ãƒ—ãƒ³ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹æ—¥ç¨‹ã€‘
2025å¹´12æœˆ:
- 12æœˆ15æ—¥ï¼ˆæ—¥ï¼‰10:00-15:00
- 12æœˆ22æ—¥ï¼ˆæ—¥ï¼‰10:00-15:00

2026å¹´1æœˆ:
- 1æœˆ12æ—¥ï¼ˆæ—¥ï¼‰10:00-15:00
- 1æœˆ19æ—¥ï¼ˆæ—¥ï¼‰10:00-15:00

2026å¹´2æœˆ:
- 2æœˆ9æ—¥ï¼ˆæ—¥ï¼‰10:00-15:00
- 2æœˆ16æ—¥ï¼ˆæ—¥ï¼‰10:00-15:00

ã€ã‚ªãƒ¼ãƒ—ãƒ³ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹å†…å®¹ã€‘
1. å­¦æ ¡èª¬æ˜ä¼šï¼ˆ10:00-11:00ï¼‰
2. ä½“é¨“æˆæ¥­ï¼ˆ11:15-12:15ï¼‰
3. æ˜¼é£Ÿãƒ»ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹ãƒ„ã‚¢ãƒ¼ï¼ˆ12:15-13:15ï¼‰
4. å€‹åˆ¥ç›¸è«‡ä¼šï¼ˆ13:30-15:00ï¼‰

ç”³è¾¼æ–¹æ³•: å…¬å¼LINEã¾ãŸã¯Webã‚µã‚¤ãƒˆã‹ã‚‰äºˆç´„
å‚åŠ è²»: ç„¡æ–™
æŒã¡ç‰©: ç­†è¨˜ç”¨å…·ã€ä¸Šå±¥ãï¼ˆä½“è‚²é¤¨ä½¿ç”¨ã®å ´åˆï¼‰

ã€è¨­ç½®ã‚³ãƒ¼ã‚¹ã€‘
1. æ™®é€šç§‘
   - å¤§å­¦é€²å­¦ã‚’ç›®æŒ‡ã™ç·åˆçš„ãªã‚«ãƒªã‚­ãƒ¥ãƒ©ãƒ 
   - é€²è·¯å®Ÿç¸¾: GMARCHä»¥ä¸Š 70%
   
2. ç¾å®¹ç§‘
   - ç¾å®¹å¸«å›½å®¶è©¦é¨“å—é¨“è³‡æ ¼å–å¾—
   - ãƒ˜ã‚¢ãƒ¡ã‚¤ã‚¯ã€ãƒã‚¤ãƒ«ã€ã‚¨ã‚¹ãƒ†ã®å®Ÿè·µ
   
3. èª¿ç†ç§‘
   - èª¿ç†å¸«å…è¨±å–å¾—
   - å’Œæ´‹ä¸­ã®å¹…åºƒã„èª¿ç†æŠ€è¡“
   
4. æƒ…å ±å‡¦ç†ç§‘
   - ITãƒ‘ã‚¹ãƒãƒ¼ãƒˆã€åŸºæœ¬æƒ…å ±æŠ€è¡“è€…è©¦é¨“å¯¾ç­–
   - ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã€Webåˆ¶ä½œ

ã€å­¦è²»ï¼ˆå¹´é¡ï¼‰ã€‘
å…¥å­¦é‡‘: Â¥200,000ï¼ˆåˆå¹´åº¦ã®ã¿ï¼‰
æˆæ¥­æ–™: Â¥600,000
æ–½è¨­è¨­å‚™è²»: Â¥100,000
å®Ÿç¿’è²»: Â¥50,000ï¼ˆã‚³ãƒ¼ã‚¹ã«ã‚ˆã‚Šç•°ãªã‚‹ï¼‰
---
åˆè¨ˆ: Â¥950,000ï¼ˆåˆå¹´åº¦ï¼‰
    Â¥750,000ï¼ˆ2å¹´ç›®ä»¥é™ï¼‰

ã€å¥¨å­¦é‡‘åˆ¶åº¦ã€‘
1. ç‰¹å¾…ç”Ÿåˆ¶åº¦
   - å…¥è©¦æˆç¸¾ä¸Šä½è€…ã¯æˆæ¥­æ–™50-100%å…é™¤
   
2. å…„å¼Ÿå§‰å¦¹å‰²å¼•
   - å…¥å­¦é‡‘50%å…é™¤
   
3. é«˜ç­‰å­¦æ ¡ç­‰å°±å­¦æ”¯æ´é‡‘
   - ä¸–å¸¯å¹´åã«å¿œã˜ã¦æ”¯æ´

4. å­¦æ ¡ç‹¬è‡ªã®å¥¨å­¦é‡‘
   - è¿”æ¸ˆä¸è¦ã®çµ¦ä»˜å‹å¥¨å­¦é‡‘ã‚ã‚Š

ã€å…¥è©¦æƒ…å ±ã€‘
æ¨è–¦å…¥è©¦:
- å‡ºé¡˜æœŸé–“: 2026å¹´1æœˆ10æ—¥-20æ—¥
- è©¦é¨“æ—¥: 2026å¹´1æœˆ25æ—¥
- è©¦é¨“ç§‘ç›®: é¢æ¥ã€ä½œæ–‡

ä¸€èˆ¬å…¥è©¦:
- å‡ºé¡˜æœŸé–“: 2026å¹´2æœˆ1æ—¥-10æ—¥
- è©¦é¨“æ—¥: 2026å¹´2æœˆ15æ—¥
- è©¦é¨“ç§‘ç›®: å›½èªã€æ•°å­¦ã€è‹±èªã€é¢æ¥

ã€ã‚ˆãã‚ã‚‹è³ªå•ã€‘
Q: è¦‹å­¦ã¯å€‹åˆ¥ã§ã‚‚å¯èƒ½ã§ã™ã‹ï¼Ÿ
A: ã¯ã„ã€å¹³æ—¥9:00-17:00ã§å€‹åˆ¥è¦‹å­¦ã‚’å—ã‘ä»˜ã‘ã¦ã„ã¾ã™ã€‚äº‹å‰ã«ãŠé›»è©±ã§ã”äºˆç´„ãã ã•ã„ã€‚

Q: åˆ¶æœã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ
A: ã¯ã„ã€æœ¬æ ¡æŒ‡å®šã®åˆ¶æœãŒã‚ã‚Šã¾ã™ã€‚è©³ç´°ã¯ã‚ªãƒ¼ãƒ—ãƒ³ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹ã§ã”ç¢ºèªã„ãŸã ã‘ã¾ã™ã€‚

Q: éƒ¨æ´»å‹•ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ
A: é‹å‹•éƒ¨10éƒ¨ã€æ–‡åŒ–éƒ¨8éƒ¨ãŒã‚ã‚Šã¾ã™ã€‚å…¨å›½å¤§ä¼šå‡ºå ´å®Ÿç¸¾ã®ã‚ã‚‹éƒ¨æ´»ã‚‚ã‚ã‚Šã¾ã™ã€‚

Q: ç•™å­¦åˆ¶åº¦ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ
A: æ™®é€šç§‘ã§ã¯å¸Œæœ›è€…å¯¾è±¡ã®çŸ­æœŸç•™å­¦ãƒ—ãƒ­ã‚°ãƒ©ãƒ ï¼ˆ2é€±é–“ï¼‰ãŒã‚ã‚Šã¾ã™ã€‚

Q: å°±è·ç‡ã¯ã©ã®ãã‚‰ã„ã§ã™ã‹ï¼Ÿ
A: å°‚é–€ç§‘ï¼ˆç¾å®¹ç§‘ãƒ»èª¿ç†ç§‘ãƒ»æƒ…å ±å‡¦ç†ç§‘ï¼‰ã®å°±è·ç‡ã¯98%ä»¥ä¸Šã§ã™ã€‚
`

// ç·Šæ€¥æ™‚ã®é€£çµ¡å…ˆæƒ…å ±
export const emergencyContact = {
  phone: '03-XXXX-XXXX',
  hours: 'å¹³æ—¥ 9:00-17:00',
  email: 'info@example-school.jp'
}

// ç”³è¾¼é–¢é€£ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
export const applicationKeywords = [
  'ç”³è¾¼', 'ç”³ã—è¾¼ã¿', 'äºˆç´„', 'ç™»éŒ²', 'ã‚¨ãƒ³ãƒˆãƒªãƒ¼',
  'ã‚­ãƒ£ãƒ³ã‚»ãƒ«', 'å¤‰æ›´', 'ç¢ºèª', 'å‚åŠ '
]

// ã‚ˆãã‚ã‚‹è³ªå•ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
export const faqKeywords = {
  access: ['ã‚¢ã‚¯ã‚»ã‚¹', 'å ´æ‰€', 'è¡Œãæ–¹', 'æœ€å¯„ã‚Šé§…', 'é§…ã‹ã‚‰', 'é“é †'],
  schedule: ['æ—¥ç¨‹', 'ã„ã¤', 'æ™‚é–“', 'é–‹å‚¬', 'ä½•æ™‚'],
  cost: ['å­¦è²»', 'è²»ç”¨', 'æ–™é‡‘', 'å€¤æ®µ', 'ãŠé‡‘', 'å¥¨å­¦é‡‘'],
  admission: ['å…¥è©¦', 'è©¦é¨“', 'å—é¨“', 'åˆæ ¼', 'å€ç‡'],
  course: ['ã‚³ãƒ¼ã‚¹', 'å­¦ç§‘', 'å°‚æ”»', 'ã‚«ãƒªã‚­ãƒ¥ãƒ©ãƒ '],
  facility: ['æ–½è¨­', 'è¨­å‚™', 'æ ¡èˆ', 'æ•™å®¤'],
  club: ['éƒ¨æ´»', 'ã‚¯ãƒ©ãƒ–', 'ã‚µãƒ¼ã‚¯ãƒ«'],
  uniform: ['åˆ¶æœ', 'æœè£…', 'ç§æœ']
}
```

---

### 2. AIå¿œç­”ãƒ­ã‚¸ãƒƒã‚¯

`lib/ai-response.ts`:

```typescript
import OpenAI from 'openai'
import { schoolKnowledge, faqKeywords, emergencyContact } from './school-knowledge'

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY!,
})

/**
 * AIå¿œç­”ã‚’ç”Ÿæˆ
 * @param userMessage ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
 * @param conversationHistory ä¼šè©±å±¥æ­´ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
 * @returns AIå¿œç­”ãƒ†ã‚­ã‚¹ãƒˆ
 */
export async function generateAIResponse(
  userMessage: string,
  conversationHistory?: { role: 'user' | 'assistant', content: string }[]
): Promise<string> {
  try {
    const messages: OpenAI.Chat.ChatCompletionMessageParam[] = [
      {
        role: 'system',
        content: `ã‚ãªãŸã¯å­¦æ ¡ã®å…¬å¼LINEã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚

ä»¥ä¸‹ã®å­¦æ ¡æƒ…å ±ã«åŸºã¥ã„ã¦ã€æ­£ç¢ºã‹ã¤è¦ªåˆ‡ã«å›ç­”ã—ã¦ãã ã•ã„ï¼š

${schoolKnowledge}

ã€å¿œç­”ãƒ«ãƒ¼ãƒ«ã€‘
1. å¸¸ã«ä¸å¯§ã§è¦ªã—ã¿ã‚„ã™ã„å£èª¿ã§è©±ã™
2. çµµæ–‡å­—ã‚’é©åº¦ã«ä½¿ç”¨ï¼ˆ1-2å€‹/ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰
3. é•·æ–‡ã¯é¿ã‘ã€ç°¡æ½”ã«ï¼ˆ200æ–‡å­—ä»¥å†…æ¨å¥¨ï¼‰
4. ä¸ç¢ºã‹ãªæƒ…å ±ã¯æä¾›ã—ãªã„
5. è³ªå•ã®æ„å›³ã‚’ç†è§£ã—ã¦é©åˆ‡ã«å›ç­”

ã€å¯¾å¿œã§ããªã„è³ªå•ã¸ã®å›ç­”ã€‘
- å€‹äººæƒ…å ±ã®å¤‰æ›´ â†’ é›»è©±ã§ãŠå•ã„åˆã‚ã›ã„ãŸã ãã‚ˆã†æ¡ˆå†…
- è¤‡é›‘ãªç›¸è«‡ â†’ å€‹åˆ¥ç›¸è«‡ä¼šã®äºˆç´„ã‚’ææ¡ˆ
- å­¦æ ¡æƒ…å ±ä»¥å¤–ã®è³ªå• â†’ ã€Œå­¦æ ¡ã«é–¢ã™ã‚‹è³ªå•ã«ãŠç­”ãˆã§ãã¾ã™ã€

ã€ç·Šæ€¥æ™‚ã®é€£çµ¡å…ˆã€‘
é›»è©±: ${emergencyContact.phone}
å—ä»˜: ${emergencyContact.hours}
ãƒ¡ãƒ¼ãƒ«: ${emergencyContact.email}`
      }
    ]
    
    // ä¼šè©±å±¥æ­´ã‚’è¿½åŠ ï¼ˆæœ€æ–°10ä»¶ã®ã¿ï¼‰
    if (conversationHistory && conversationHistory.length > 0) {
      const recentHistory = conversationHistory.slice(-10)
      messages.push(...recentHistory.map(msg => ({
        role: msg.role,
        content: msg.content
      })))
    }
    
    // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
    messages.push({
      role: 'user',
      content: userMessage
    })
    
    // OpenAI APIå‘¼ã³å‡ºã—
    const completion = await openai.chat.completions.create({
      model: process.env.OPENAI_MODEL || 'gpt-4o-mini',
      messages: messages,
      temperature: parseFloat(process.env.OPENAI_TEMPERATURE || '0.7'),
      max_tokens: parseInt(process.env.OPENAI_MAX_TOKENS || '500'),
    })
    
    const response = completion.choices[0].message.content
    
    if (!response) {
      return getDefaultErrorMessage()
    }
    
    return response
    
  } catch (error) {
    console.error('OpenAI API error:', error)
    
    // ã‚¨ãƒ©ãƒ¼ã®ç¨®é¡ã«å¿œã˜ãŸå¿œç­”
    if (error instanceof Error) {
      if (error.message.includes('rate_limit')) {
        return 'ãŸã ã„ã¾å¤šãã®ãŠå•ã„åˆã‚ã›ã‚’ã„ãŸã ã„ã¦ãŠã‚Šã€å°‘ã€…ãŠæ™‚é–“ã‚’ã„ãŸã ã„ã¦ãŠã‚Šã¾ã™ã€‚ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ğŸ™‡'
      } else if (error.message.includes('api_key')) {
        console.error('OpenAI API key error')
        return getDefaultErrorMessage()
      }
    }
    
    return getDefaultErrorMessage()
  }
}

/**
 * ã‚ˆãã‚ã‚‹è³ªå•ã‹ã©ã†ã‹åˆ¤å®š
 */
export function isFrequentQuestion(message: string): boolean {
  const allKeywords = Object.values(faqKeywords).flat()
  return allKeywords.some(keyword => message.includes(keyword))
}

/**
 * ç”³è¾¼é–¢é€£ã®è³ªå•ã‹ã©ã†ã‹åˆ¤å®š
 */
export function isApplicationRelated(message: string): boolean {
  const keywords = [
    'ç”³è¾¼', 'ç”³ã—è¾¼ã¿', 'äºˆç´„', 'ç™»éŒ²', 'ã‚¨ãƒ³ãƒˆãƒªãƒ¼',
    'ã‚­ãƒ£ãƒ³ã‚»ãƒ«', 'å¤‰æ›´', 'ç¢ºèª', 'å‚åŠ '
  ]
  
  return keywords.some(keyword => message.includes(keyword))
}

/**
 * ç·Šæ€¥å¯¾å¿œãŒå¿…è¦ãªè³ªå•ã‹ã©ã†ã‹åˆ¤å®š
 */
export function isUrgentQuestion(message: string): boolean {
  const keywords = [
    'ç·Šæ€¥', 'æ€¥ã', 'ã™ã', 'ä»Šæ—¥', 'æœ¬æ—¥',
    'å›°ã£ã¦', 'ãƒˆãƒ©ãƒ–ãƒ«', 'å•é¡Œ'
  ]
  
  return keywords.some(keyword => message.includes(keyword))
}

/**
 * ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
 */
function getDefaultErrorMessage(): string {
  return `ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚ä¸€æ™‚çš„ã«ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ãŠã‚Šã¾ã™ã€‚

ãŠæ€¥ãã®å ´åˆã¯ã€ãŠé›»è©±ã§ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚
ğŸ“ ${emergencyContact.phone}
â° ${emergencyContact.hours}`
}

/**
 * ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡ã®æ¦‚ç®—è¨ˆç®—
 */
export function estimateTokens(text: string): number {
  // æ—¥æœ¬èªã®å ´åˆã€ãŠãŠã‚ˆã1æ–‡å­—=2ãƒˆãƒ¼ã‚¯ãƒ³
  return text.length * 2
}
```

---

### 3. ä¼šè©±å±¥æ­´ç®¡ç†

`lib/conversation-history.ts`:

```typescript
import { supabaseAdmin } from './supabase'

export interface ConversationMessage {
  role: 'user' | 'assistant' | 'system'
  content: string
  created_at?: string
}

/**
 * ä¼šè©±å±¥æ­´ã‚’ä¿å­˜
 */
export async function saveMessage(
  lineUserId: string,
  role: 'user' | 'assistant',
  message: string
): Promise<void> {
  try {
    await supabaseAdmin
      .from('conversation_history')
      .insert({
        line_user_id: lineUserId,
        role: role,
        message: message
      })
  } catch (error) {
    console.error('Error saving message:', error)
    // ã‚¨ãƒ©ãƒ¼ã§ã‚‚å‡¦ç†ã¯ç¶™ç¶šï¼ˆä¼šè©±å±¥æ­´ä¿å­˜å¤±æ•—ã¯è‡´å‘½çš„ã§ã¯ãªã„ï¼‰
  }
}

/**
 * ä¼šè©±å±¥æ­´ã‚’å–å¾—
 */
export async function getConversationHistory(
  lineUserId: string,
  limit: number = 10
): Promise<ConversationMessage[]> {
  try {
    const { data, error } = await supabaseAdmin
      .from('conversation_history')
      .select('role, message as content, created_at')
      .eq('line_user_id', lineUserId)
      .order('created_at', { ascending: false })
      .limit(limit)
    
    if (error) throw error
    
    // æ™‚ç³»åˆ—é †ã«ä¸¦ã³æ›¿ãˆï¼ˆå¤ã„â†’æ–°ã—ã„ï¼‰
    return (data || [])
      .reverse()
      .map(msg => ({
        role: msg.role as 'user' | 'assistant',
        content: msg.content
      }))
    
  } catch (error) {
    console.error('Error getting conversation history:', error)
    return []
  }
}

/**
 * ä¼šè©±å±¥æ­´ã‚’å‰Šé™¤ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¦æœ›æ™‚ï¼‰
 */
export async function clearConversationHistory(
  lineUserId: string
): Promise<boolean> {
  try {
    const { error } = await supabaseAdmin
      .from('conversation_history')
      .delete()
      .eq('line_user_id', lineUserId)
    
    if (error) throw error
    return true
    
  } catch (error) {
    console.error('Error clearing conversation history:', error)
    return false
  }
}

/**
 * å¤ã„ä¼šè©±å±¥æ­´ã‚’å‰Šé™¤ï¼ˆãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ç”¨ï¼‰
 */
export async function cleanupOldHistory(daysOld: number = 30): Promise<void> {
  try {
    const cutoffDate = new Date()
    cutoffDate.setDate(cutoffDate.getDate() - daysOld)
    
    await supabaseAdmin
      .from('conversation_history')
      .delete()
      .lt('created_at', cutoffDate.toISOString())
    
    console.log(`Cleaned up conversation history older than ${daysOld} days`)
    
  } catch (error) {
    console.error('Error cleaning up old history:', error)
  }
}

/**
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä¼šè©±çµ±è¨ˆã‚’å–å¾—
 */
export async function getUserConversationStats(
  lineUserId: string
): Promise<{
  totalMessages: number
  firstMessageDate: string | null
  lastMessageDate: string | null
}> {
  try {
    const { data, error } = await supabaseAdmin
      .from('conversation_history')
      .select('created_at')
      .eq('line_user_id', lineUserId)
      .order('created_at', { ascending: true })
    
    if (error) throw error
    
    return {
      totalMessages: data?.length || 0,
      firstMessageDate: data?.[0]?.created_at || null,
      lastMessageDate: data?.[data.length - 1]?.created_at || null
    }
    
  } catch (error) {
    console.error('Error getting conversation stats:', error)
    return {
      totalMessages: 0,
      firstMessageDate: null,
      lastMessageDate: null
    }
  }
}
```

---

### 4. çµ±åˆWebhookå‡¦ç†

`app/api/line/webhook/route.ts`:

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { Client, WebhookEvent, validateSignature, TextMessage } from '@line/bot-sdk'
import { supabaseAdmin } from '@/lib/supabase'
import { 
  generateAIResponse, 
  isApplicationRelated, 
  isUrgentQuestion 
} from '@/lib/ai-response'
import {
  saveMessage,
  getConversationHistory,
  clearConversationHistory
} from '@/lib/conversation-history'

// LINE ClientåˆæœŸåŒ–
const client = new Client({
  channelAccessToken: process.env.LINE_CHANNEL_ACCESS_TOKEN!,
  channelSecret: process.env.LINE_CHANNEL_SECRET!,
})

/**
 * LINE Webhook ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
 */
export async function POST(request: NextRequest) {
  try {
    const body = await request.text()
    const signature = request.headers.get('x-line-signature')

    // ç½²åæ¤œè¨¼
    if (!signature) {
      console.error('No signature provided')
      return NextResponse.json({ error: 'No signature' }, { status: 401 })
    }

    const isValid = validateSignature(
      body,
      process.env.LINE_CHANNEL_SECRET!,
      signature
    )

    if (!isValid) {
      console.error('Invalid signature')
      return NextResponse.json({ error: 'Invalid signature' }, { status: 401 })
    }

    const events: WebhookEvent[] = JSON.parse(body).events

    // å„ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‡¦ç†
    await Promise.all(events.map(event => handleEvent(event)))

    return NextResponse.json({ success: true })
    
  } catch (error) {
    console.error('LINE webhook error:', error)
    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    )
  }
}

/**
 * ã‚¤ãƒ™ãƒ³ãƒˆæŒ¯ã‚Šåˆ†ã‘
 */
async function handleEvent(event: WebhookEvent): Promise<void> {
  try {
    switch (event.type) {
      case 'follow':
        await handleFollow(event)
        break
      
      case 'message':
        if (event.message.type === 'text') {
          await handleTextMessage(event)
        }
        break
      
      case 'unfollow':
        await handleUnfollow(event)
        break
      
      default:
        console.log('Unhandled event type:', event.type)
    }
  } catch (error) {
    console.error('Error handling event:', error)
  }
}

/**
 * å‹é”è¿½åŠ æ™‚ã®å‡¦ç†ï¼ˆç”³è¾¼é€£æºï¼‰
 */
async function handleFollow(event: any): Promise<void> {
  const userId = event.source.userId
  const timestamp = event.timestamp
  
  // LIFFã®stateãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
  const token = event.follow?.params?.liff?.state
  
  try {
    if (!token) {
      // ãƒˆãƒ¼ã‚¯ãƒ³ãŒãªã„å ´åˆã¯é€šå¸¸ã®ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      await sendWelcomeMessage(event.replyToken, userId)
      return
    }

    // ç”³è¾¼æƒ…å ±ã‚’æ¤œç´¢
    const { data: applicant, error: fetchError } = await supabaseAdmin
      .from('applicants')
      .select('*')
      .eq('token', token)
      .single()

    if (fetchError || !applicant) {
      await client.replyMessage(event.replyToken, {
        type: 'text',
        text: 'ç”³è¾¼æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚\nãŠæ‰‹æ•°ã§ã™ãŒã€å†åº¦ç”³è¾¼ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ãŠç”³ã—è¾¼ã¿ãã ã•ã„ã€‚'
      })
      return
    }

    // ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æœŸé™ãƒã‚§ãƒƒã‚¯
    const now = new Date()
    const expiresAt = new Date(applicant.token_expires_at)
    
    if (now > expiresAt) {
      await supabaseAdmin
        .from('applicants')
        .update({ status: 'expired' })
        .eq('id', applicant.id)

      await client.replyMessage(event.replyToken, {
        type: 'text',
        text: 'ç”³è¾¼URLã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¦ã„ã¾ã™ã€‚\nãŠæ‰‹æ•°ã§ã™ãŒã€å†åº¦ç”³è¾¼ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ãŠç”³ã—è¾¼ã¿ãã ã•ã„ã€‚'
      })
      return
    }

    // LINE IDç´ä»˜ã‘
    const { error: updateError } = await supabaseAdmin
      .from('applicants')
      .update({
        line_user_id: userId,
        status: 'completed',
        updated_at: new Date().toISOString()
      })
      .eq('id', applicant.id)

    if (updateError) {
      throw updateError
    }

    // ãƒ­ã‚°è¨˜éŒ²
    await supabaseAdmin.from('application_logs').insert({
      applicant_id: applicant.id,
      action: 'line_linked',
      timestamp: new Date().toISOString()
    })

    // ç”³è¾¼å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
    await sendApplicationCompleteMessage(event.replyToken, applicant)

  } catch (error) {
    console.error('Error in handleFollow:', error)
    await client.replyMessage(event.replyToken, {
      type: 'text',
      text: 'ç”³è¾¼å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\nãŠæ‰‹æ•°ã§ã™ãŒã€ãŠé›»è©±ã§ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚\nğŸ“ 03-XXXX-XXXX'
    })
  }
}

/**
 * ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡æ™‚ã®å‡¦ç†ï¼ˆAIå¿œç­”ï¼‰
 */
async function handleTextMessage(event: any): Promise<void> {
  const userMessage = event.message.text
  const userId = event.source.userId
  
  try {
    // ç‰¹æ®Šã‚³ãƒãƒ³ãƒ‰ã®å‡¦ç†
    if (userMessage === 'ãƒªã‚»ãƒƒãƒˆ' || userMessage === 'reset') {
      await clearConversationHistory(userId)
      await client.replyMessage(event.replyToken, {
        type: 'text',
        text: 'ä¼šè©±å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚\næ–°ã—ãè³ªå•ã‚’ã©ã†ãï¼ğŸ˜Š'
      })
      return
    }
    
    // ç”³è¾¼é–¢é€£ã®è³ªå•ã®å ´åˆ
    if (isApplicationRelated(userMessage)) {
      await handleApplicationQuery(event.replyToken, userId, userMessage)
      return
    }
    
    // ç·Šæ€¥ã®è³ªå•ã®å ´åˆ
    if (isUrgentQuestion(userMessage)) {
      await handleUrgentQuery(event.replyToken, userMessage)
      return
    }
    
    // é€šå¸¸ã®AIå¿œç­”
    // ä¼šè©±å±¥æ­´ã‚’å–å¾—
    const history = await getConversationHistory(userId, 10)
    
    // AIå¿œç­”ç”Ÿæˆ
    const aiResponse = await generateAIResponse(userMessage, history)
    
    // å¿œç­”ã‚’é€ä¿¡
    await client.replyMessage(event.replyToken, {
      type: 'text',
      text: aiResponse
    })
    
    // ä¼šè©±å±¥æ­´ã‚’ä¿å­˜
    await saveMessage(userId, 'user', userMessage)
    await saveMessage(userId, 'assistant', aiResponse)
    
  } catch (error) {
    console.error('Error in handleTextMessage:', error)
    await client.replyMessage(event.replyToken, {
      type: 'text',
      text: 'ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚ä¸€æ™‚çš„ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\nã—ã°ã‚‰ãã—ã¦ã‹ã‚‰ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚'
    })
  }
}

/**
 * ãƒ•ã‚©ãƒ­ãƒ¼è§£é™¤æ™‚ã®å‡¦ç†
 */
async function handleUnfollow(event: any): Promise<void> {
  const userId = event.source.userId
  
  try {
    // LINE IDç´ä»˜ã‘ã‚’è§£é™¤ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
    await supabaseAdmin
      .from('applicants')
      .update({ line_user_id: null })
      .eq('line_user_id', userId)
    
    // ä¼šè©±å±¥æ­´ã‚’å‰Šé™¤ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
    // await clearConversationHistory(userId)
    
    console.log(`User ${userId} unfollowed`)
    
  } catch (error) {
    console.error('Error in handleUnfollow:', error)
  }
}

/**
 * ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
 */
async function sendWelcomeMessage(replyToken: string, userId: string): Promise<void> {
  const message: TextMessage = {
    type: 'text',
    text: `ã”ç™»éŒ²ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼ğŸ‰

â—‹â—‹é«˜ç­‰å­¦æ ¡ã®å…¬å¼LINEã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã™ã€‚

ã€ã§ãã‚‹ã“ã¨ã€‘
âœ… ã‚ªãƒ¼ãƒ—ãƒ³ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹ã®ç”³è¾¼
âœ… ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ã®ãŠçŸ¥ã‚‰ã›
âœ… å­¦æ ¡ã«é–¢ã™ã‚‹è³ªå•ã¸ã®è‡ªå‹•å›ç­”

è³ªå•ãŒã‚ã‚Œã°ãŠæ°—è»½ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã—ã¦ãã ã•ã„ã€‚
AIãŒ24æ™‚é–“å¯¾å¿œã„ãŸã—ã¾ã™ğŸ¤–

ä¾‹ï¼‰
ã€Œã‚¢ã‚¯ã‚»ã‚¹ã‚’æ•™ãˆã¦ã€
ã€Œã‚ªãƒ¼ãƒ—ãƒ³ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹ã¯ã„ã¤ï¼Ÿã€
ã€Œå­¦è²»ã«ã¤ã„ã¦çŸ¥ã‚ŠãŸã„ã€`
  }
  
  await client.replyMessage(replyToken, message)
}

/**
 * ç”³è¾¼å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
 */
async function sendApplicationCompleteMessage(
  replyToken: string, 
  applicant: any
): Promise<void> {
  const visitDate = new Date(applicant.visit_date)
  const formattedDate = visitDate.toLocaleDateString('ja-JP', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
    weekday: 'short'
  })
  
  const message: TextMessage = {
    type: 'text',
    text: `${applicant.name}ã•ã‚“ã€ãŠç”³ã—è¾¼ã¿ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼âœ¨

ã€ç”³è¾¼å†…å®¹ã€‘
ğŸ“… å‚åŠ æ—¥: ${formattedDate}
ğŸ« å‡ºèº«æ ¡: ${applicant.school_name}
ğŸ‘¤ å­¦å¹´: ${applicant.grade}
ğŸ‘¥ åŒä¼´è€…: ${applicant.companion_count}å

ã€å½“æ—¥ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã€‘
10:00-11:00 å­¦æ ¡èª¬æ˜ä¼š
11:15-12:15 ä½“é¨“æˆæ¥­
12:15-13:15 æ˜¼é£Ÿãƒ»ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹ãƒ„ã‚¢ãƒ¼
13:30-15:00 å€‹åˆ¥ç›¸è«‡ä¼š

ã€æŒã¡ç‰©ã€‘
ãƒ»ç­†è¨˜ç”¨å…·
ãƒ»ä¸Šå±¥ãï¼ˆä½“è‚²é¤¨ä½¿ç”¨ã®å ´åˆï¼‰

å‰æ—¥ã«ãƒªãƒã‚¤ãƒ³ãƒ‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãŠé€ã‚Šã—ã¾ã™ã€‚
å½“æ—¥ãŠä¼šã„ã§ãã‚‹ã“ã¨ã‚’æ¥½ã—ã¿ã«ã—ã¦ã„ã¾ã™ï¼

ã”è³ªå•ãŒã‚ã‚Œã°ã€ã“ã®LINEã§ãŠæ°—è»½ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã—ã¦ãã ã•ã„ã€‚
AIãŒè‡ªå‹•ã§ãŠç­”ãˆã—ã¾ã™ğŸ¤–`
  }
  
  await client.replyMessage(replyToken, message)
}

/**
 * ç”³è¾¼é–¢é€£ã®è³ªå•ã¸ã®å¿œç­”
 */
async function handleApplicationQuery(
  replyToken: string,
  userId: string,
  userMessage: string
): Promise<void> {
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç”³è¾¼æƒ…å ±ã‚’ç¢ºèª
  const { data: applicant } = await supabaseAdmin
    .from('applicants')
    .select('*')
    .eq('line_user_id', userId)
    .order('created_at', { ascending: false })
    .limit(1)
    .single()
  
  if (applicant) {
    const visitDate = new Date(applicant.visit_date).toLocaleDateString('ja-JP', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      weekday: 'short'
    })
    
    await client.replyMessage(replyToken, {
      type: 'text',
      text: `ã€ç¾åœ¨ã®ãŠç”³ã—è¾¼ã¿çŠ¶æ³ã€‘

ğŸ“… å‚åŠ äºˆå®šæ—¥: ${visitDate}
âœ… å—ä»˜å®Œäº†ã—ã¦ã„ã¾ã™

ã€ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒ»å¤‰æ›´ã«ã¤ã„ã¦ã€‘
ãŠæ‰‹æ•°ã§ã™ãŒã€ãŠé›»è©±ã§ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚
ğŸ“ TEL: 03-XXXX-XXXX
â° å—ä»˜æ™‚é–“: å¹³æ—¥ 9:00-17:00`
    })
  } else {
    await client.replyMessage(replyToken, {
      type: 'text',
      text: `ã‚ªãƒ¼ãƒ—ãƒ³ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹ã®ãŠç”³ã—è¾¼ã¿ã¯ã€
ã“ã¡ã‚‰ã®LINEã¾ãŸã¯å…¬å¼ã‚µã‚¤ãƒˆã‹ã‚‰å¯èƒ½ã§ã™ã€‚

ã€ç”³è¾¼æ–¹æ³•ã€‘
1. LINEã§ã®ç”³è¾¼
   â†’ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ã€Œç”³ã—è¾¼ã¿ãŸã„ã€ã¨ãŠé€ã‚Šãã ã•ã„
   
2. Webã‚µã‚¤ãƒˆã§ã®ç”³è¾¼
   â†’ https://example-school.jp/opencampus

ã€æ¬¡å›é–‹å‚¬æ—¥ç¨‹ã€‘
ãƒ»12æœˆ15æ—¥ï¼ˆæ—¥ï¼‰
ãƒ»12æœˆ22æ—¥ï¼ˆæ—¥ï¼‰
ãƒ»1æœˆ12æ—¥ï¼ˆæ—¥ï¼‰

ã©ã®æ—¥ç¨‹ã‚’ã”å¸Œæœ›ã§ã™ã‹ï¼ŸğŸ˜Š`
    })
  }
}

/**
 * ç·Šæ€¥ã®è³ªå•ã¸ã®å¿œç­”
 */
async function handleUrgentQuery(
  replyToken: string,
  userMessage: string
): Promise<void> {
  await client.replyMessage(replyToken, {
    type: 'text',
    text: `ãŠæ€¥ãã®ã”ç”¨ä»¶ã§ã™ã­ã€‚
æã‚Œå…¥ã‚Šã¾ã™ãŒã€ç›´æ¥ãŠé›»è©±ã§ãŠå•ã„åˆã‚ã›ã„ãŸã ã‘ã¾ã™ã§ã—ã‚‡ã†ã‹ã€‚

ğŸ“ TEL: 03-XXXX-XXXX
â° å—ä»˜æ™‚é–“: å¹³æ—¥ 9:00-17:00

æ‹…å½“è€…ãŒç›´æ¥å¯¾å¿œã•ã›ã¦ã„ãŸã ãã¾ã™ã€‚`
  })
}
```

---

## ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †

### ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆ

```bash
# é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•
npm run dev

# åˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ngrokèµ·å‹•ï¼ˆWebhookå—ä¿¡ç”¨ï¼‰
ngrok http 3000

# ngrokã®URLã‚’ã‚³ãƒ”ãƒ¼
# ä¾‹: https://xxxx-xx-xx-xx-xx.ngrok-free.app
```

### ã‚¹ãƒ†ãƒƒãƒ—2: LINE Webhookè¨­å®šï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰

1. LINE Developers Console ã‚’é–‹ã
2. ãƒãƒ£ãƒãƒ«è¨­å®š â†’ Messaging API
3. Webhook URL ã‚’è¨­å®š:
   ```
   https://xxxx-xx-xx-xx-xx.ngrok-free.app/api/line/webhook
   ```
4. ã€Œæ¤œè¨¼ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
5. æˆåŠŸã—ãŸã‚‰ã€ŒWebhookã®åˆ©ç”¨ã€ã‚’ONã«ã™ã‚‹

### ã‚¹ãƒ†ãƒƒãƒ—3: ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

1. LINEå…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‹é”è¿½åŠ 
2. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
3. AIå¿œç­”ãŒè¿”ã£ã¦ãã‚‹ã‹ç¢ºèª

```
ãƒ†ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¾‹:
- ã€Œã“ã‚“ã«ã¡ã¯ã€
- ã€Œã‚¢ã‚¯ã‚»ã‚¹ã‚’æ•™ãˆã¦ã€
- ã€Œã‚ªãƒ¼ãƒ—ãƒ³ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹ã®æ—¥ç¨‹ã¯ï¼Ÿã€
- ã€Œå­¦è²»ã«ã¤ã„ã¦çŸ¥ã‚ŠãŸã„ã€
```

### ã‚¹ãƒ†ãƒƒãƒ—4: Vercelã«ãƒ‡ãƒ—ãƒ­ã‚¤

```bash
# Gitã«ã‚³ãƒŸãƒƒãƒˆ
git add .
git commit -m "Add AI auto-response feature"
git push origin main

# VercelãŒè‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤
```

### ã‚¹ãƒ†ãƒƒãƒ—5: LINE Webhookè¨­å®šï¼ˆæœ¬ç•ªç”¨ï¼‰

1. LINE Developers Console ã‚’é–‹ã
2. Webhook URL ã‚’å¤‰æ›´:
   ```
   https://your-app.vercel.app/api/line/webhook
   ```
3. ã€Œæ¤œè¨¼ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
4. æˆåŠŸã‚’ç¢ºèª

### ã‚¹ãƒ†ãƒƒãƒ—6: æœ¬ç•ªãƒ†ã‚¹ãƒˆ

1. åˆ¥ã®LINEã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§å‹é”è¿½åŠ 
2. å„ç¨®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ†ã‚¹ãƒˆ
3. ç”³è¾¼ãƒ•ãƒ­ãƒ¼ã‚‚ãƒ†ã‚¹ãƒˆ

---

## å‹•ä½œç¢ºèª

### ãƒ†ã‚¹ãƒˆãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

#### 1. å‹é”è¿½åŠ ï¼ˆç”³è¾¼é€£æºãªã—ï¼‰

- [ ] ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå±Šã
- [ ] ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹ãŒé©åˆ‡

#### 2. å‹é”è¿½åŠ ï¼ˆç”³è¾¼é€£æºã‚ã‚Šï¼‰

- [ ] ç”³è¾¼å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå±Šã
- [ ] Supabaseã«line_user_idãŒä¿å­˜ã•ã‚Œã‚‹
- [ ] statusãŒ'completed'ã«ãªã‚‹

#### 3. AIå¿œç­”ï¼ˆåŸºæœ¬ï¼‰

- [ ] ã€Œã“ã‚“ã«ã¡ã¯ã€ã«é©åˆ‡ã«å¿œç­”
- [ ] ã€Œã‚ã‚ŠãŒã¨ã†ã€ã«é©åˆ‡ã«å¿œç­”

#### 4. AIå¿œç­”ï¼ˆå­¦æ ¡æƒ…å ±ï¼‰

- [ ] ã€Œã‚¢ã‚¯ã‚»ã‚¹ã‚’æ•™ãˆã¦ã€ã«æ­£ç¢ºãªæƒ…å ±ã§å¿œç­”
- [ ] ã€Œæ—¥ç¨‹ã¯ï¼Ÿã€ã«ã‚ªãƒ¼ãƒ—ãƒ³ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹æ—¥ç¨‹ã§å¿œç­”
- [ ] ã€Œå­¦è²»ã¯ï¼Ÿã€ã«å­¦è²»æƒ…å ±ã§å¿œç­”
- [ ] ã€Œå…¥è©¦ã«ã¤ã„ã¦ã€ã«å…¥è©¦æƒ…å ±ã§å¿œç­”

#### 5. AIå¿œç­”ï¼ˆä¼šè©±ç¶™ç¶šï¼‰

- [ ] è¤‡æ•°ã®è³ªå•ã‚’ã—ã¦ã‚‚æ–‡è„ˆã‚’ç†è§£ã—ã¦ã„ã‚‹
- [ ] å‰ã®è³ªå•ã‚’è¦šãˆã¦ã„ã‚‹

#### 6. ç”³è¾¼é–¢é€£ã®è³ªå•

- [ ] ã€Œç”³è¾¼çŠ¶æ³ã‚’ç¢ºèªã—ãŸã„ã€ã«é©åˆ‡ã«å¿œç­”
- [ ] ç”³è¾¼è€…ã«ã¯ç¾åœ¨ã®çŠ¶æ³ã‚’è¡¨ç¤º
- [ ] æœªç”³è¾¼è€…ã«ã¯ç”³è¾¼æ–¹æ³•ã‚’æ¡ˆå†…

#### 7. ç‰¹æ®Šã‚³ãƒãƒ³ãƒ‰

- [ ] ã€Œãƒªã‚»ãƒƒãƒˆã€ã§ä¼šè©±å±¥æ­´ãŒã‚¯ãƒªã‚¢ã•ã‚Œã‚‹

#### 8. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

- [ ] OpenAI APIã‚¨ãƒ©ãƒ¼æ™‚ã‚‚é©åˆ‡ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿”ã™
- [ ] Supabaseã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã—ãªã„

---

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### 1. AIå¿œç­”ãŒè¿”ã£ã¦ã“ãªã„

**åŸå› 1: OpenAI APIã‚­ãƒ¼ãŒç„¡åŠ¹**

```bash
# ç’°å¢ƒå¤‰æ•°ã‚’ç¢ºèª
echo $OPENAI_API_KEY

# Vercelã®ç’°å¢ƒå¤‰æ•°ã‚’ç¢ºèª
# Dashboard â†’ Settings â†’ Environment Variables
```

**è§£æ±ºç­–:**
- APIã‚­ãƒ¼ã‚’å†ç™ºè¡Œ
- ç’°å¢ƒå¤‰æ•°ã‚’å†è¨­å®š
- Vercelã‚’å†ãƒ‡ãƒ—ãƒ­ã‚¤

**åŸå› 2: æ”¯æ‰•ã„æ–¹æ³•æœªç™»éŒ²**

```
OpenAI Platform â†’ Settings â†’ Billing
```

**è§£æ±ºç­–:**
- ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ç™»éŒ²
- æœ€ä½$5ãƒãƒ£ãƒ¼ã‚¸

---

### 2. ä¼šè©±å±¥æ­´ãŒä¿å­˜ã•ã‚Œãªã„

**åŸå› : Supabaseãƒ†ãƒ¼ãƒ–ãƒ«ãŒæœªä½œæˆ**

```sql
-- ãƒ†ãƒ¼ãƒ–ãƒ«å­˜åœ¨ç¢ºèª
SELECT * FROM conversation_history LIMIT 1;
```

**è§£æ±ºç­–:**
- ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆSQLã‚’å®Ÿè¡Œ
- RLSãƒãƒªã‚·ãƒ¼ã‚’ç¢ºèª

---

### 3. ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒé…ã„

**åŸå› : ãƒ¢ãƒ‡ãƒ«ãŒé‡ã„**

```bash
# ç’°å¢ƒå¤‰æ•°ã‚’ç¢ºèª
OPENAI_MODEL=gpt-4o-mini  # â† ã“ã‚ŒãŒæ¨å¥¨
```

**é«˜é€ŸåŒ–ã®æ–¹æ³•:**
1. `gpt-4o-mini`ã‚’ä½¿ç”¨ï¼ˆæœ€é€Ÿï¼‰
2. `max_tokens`ã‚’æ¸›ã‚‰ã™ï¼ˆ500æ¨å¥¨ï¼‰
3. ä¼šè©±å±¥æ­´ã®å–å¾—ä»¶æ•°ã‚’æ¸›ã‚‰ã™ï¼ˆ10ä»¶æ¨å¥¨ï¼‰

---

### 4. ã‚³ã‚¹ãƒˆãŒé«˜ã„

**åŸå› : å¤§é‡ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**

**ç¢ºèªæ–¹æ³•:**
```
OpenAI Platform â†’ Usage
```

**ã‚³ã‚¹ãƒˆå‰Šæ¸›ç­–:**
1. ã‚ˆãã‚ã‚‹è³ªå•ã¯å›ºå®šå¿œç­”ã«ã™ã‚‹
2. `temperature`ã‚’ä¸‹ã’ã‚‹ï¼ˆ0.5-0.7ï¼‰
3. `max_tokens`ã‚’æ¸›ã‚‰ã™
4. æœˆé¡ä¸Šé™ã‚’è¨­å®š

---

### 5. ç½²åæ¤œè¨¼ã‚¨ãƒ©ãƒ¼

**ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:**
```
Invalid signature
```

**åŸå› : LINE_CHANNEL_SECRETãŒé–“é•ã£ã¦ã„ã‚‹**

**è§£æ±ºç­–:**
```bash
# LINE Developers Consoleã‹ã‚‰æ­£ã—ã„å€¤ã‚’ã‚³ãƒ”ãƒ¼
# Messaging API â†’ Channel Secret

# ç’°å¢ƒå¤‰æ•°ã‚’æ›´æ–°
LINE_CHANNEL_SECRET=æ­£ã—ã„å€¤
```

---

### 6. WebhookãŒå±Šã‹ãªã„

**ç¢ºèªé …ç›®:**
1. Webhook URLãŒæ­£ã—ã„ã‹
2. WebhookãŒã€Œåˆ©ç”¨ã™ã‚‹ã€ã«ãªã£ã¦ã„ã‚‹ã‹
3. LINEå…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒå‹é”è¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã‹
4. Vercelã®ãƒ­ã‚°ã‚’ç¢ºèª

**Vercelãƒ­ã‚°ç¢ºèª:**
```
Vercel Dashboard â†’ Deployments â†’ [æœ€æ–°] â†’ Runtime Logs
```

---

### 7. ãƒ‡ãƒãƒƒã‚°æ–¹æ³•

**ãƒ­ã‚°å‡ºåŠ›:**

```typescript
// webhook/route.ts ã«è¿½åŠ 
console.log('Event received:', JSON.stringify(event, null, 2))
console.log('User message:', userMessage)
console.log('AI response:', aiResponse)
```

**Vercelã§ãƒ­ã‚°ç¢ºèª:**
```
Dashboard â†’ Deployments â†’ Functions â†’ View logs
```

---

## ğŸ’° ã‚³ã‚¹ãƒˆè©¦ç®—ï¼ˆå†æ²ï¼‰

### OpenAI APIï¼ˆgpt-4o-miniï¼‰

| åˆ©ç”¨å›æ•°/æœˆ | ãƒˆãƒ¼ã‚¯ãƒ³æ•° | ã‚³ã‚¹ãƒˆï¼ˆå††ï¼‰ |
|-----------|----------|------------|
| 100å› | 50,000 | Â¥3 |
| 1,000å› | 500,000 | Â¥32 |
| 5,000å› | 2,500,000 | Â¥158 |
| 10,000å› | 5,000,000 | Â¥315 |

**çµè«–: éå¸¸ã«å®‰ä¾¡ï¼ˆæœˆé–“10,000å›ã§ã‚‚Â¥315ï¼‰**

---

## ğŸ“š å‚è€ƒãƒªãƒ³ã‚¯

### OpenAI
- ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ: https://platform.openai.com/docs
- æ–™é‡‘: https://openai.com/pricing
- ä½¿ç”¨é‡ç¢ºèª: https://platform.openai.com/usage

### LINE Messaging API
- ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ: https://developers.line.biz/ja/docs/messaging-api/
- Node.js SDK: https://github.com/line/line-bot-sdk-nodejs

### Vercel
- ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ: https://vercel.com/docs
- ç’°å¢ƒå¤‰æ•°: https://vercel.com/docs/environment-variables

### Supabase
- ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ: https://supabase.com/docs
- SQL Editor: Dashboard â†’ SQL Editor

---

## âœ… å®Œäº†ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### äº‹å‰æº–å‚™
- [ ] OpenAI ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ
- [ ] OpenAI APIã‚­ãƒ¼å–å¾—
- [ ] OpenAI æ”¯æ‰•ã„æ–¹æ³•ç™»éŒ²
- [ ] ä½¿ç”¨é‡ä¸Šé™è¨­å®š

### å®Ÿè£…
- [ ] ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
- [ ] ç’°å¢ƒå¤‰æ•°è¨­å®šï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰
- [ ] ç’°å¢ƒå¤‰æ•°è¨­å®šï¼ˆVercelï¼‰
- [ ] Supabaseãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
- [ ] ã‚³ãƒ¼ãƒ‰å®Ÿè£…å®Œäº†

### ãƒ†ã‚¹ãƒˆ
- [ ] ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆæˆåŠŸ
- [ ] Vercelãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸ
- [ ] LINE Webhookè¨­å®šå®Œäº†
- [ ] æœ¬ç•ªãƒ†ã‚¹ãƒˆæˆåŠŸ

### ç¢ºèª
- [ ] å‹é”è¿½åŠ ãŒå‹•ä½œã™ã‚‹
- [ ] AIå¿œç­”ãŒå‹•ä½œã™ã‚‹
- [ ] ç”³è¾¼é€£æºãŒå‹•ä½œã™ã‚‹
- [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒé©åˆ‡

---

## ğŸ‰ å®Œæˆï¼

ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼
ã“ã‚Œã§1ã¤ã®LINEã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã€Œã‚ªãƒ¼ãƒ—ãƒ³ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹ç”³è¾¼ã€ã¨ã€ŒAIè‡ªå‹•å¿œç­”ã€ã®ä¸¡æ–¹ãŒå®Ÿç¾ã§ãã¾ã—ãŸã€‚

**æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:**
1. å®Ÿéš›ã«é‹ç”¨é–‹å§‹
2. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã‚’åé›†
3. AIå¿œç­”ã®æ”¹å–„
4. å­¦æ ¡æƒ…å ±ã®æ›´æ–°

**ã•ã‚‰ãªã‚‹æ”¹å–„æ¡ˆ:**
- ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®è¿½åŠ 
- ãƒ—ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è‡ªå‹•é€ä¿¡
- çµ±è¨ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®ä½œæˆ
- ç”»åƒãƒ»å‹•ç”»å¯¾å¿œ

ä½•ã‹è³ªå•ãŒã‚ã‚Œã°ã€ã„ã¤ã§ã‚‚ãŠèããã ã•ã„ï¼ğŸš€

---

ä½œæˆæ—¥: 2025å¹´11æœˆ18æ—¥
ãƒãƒ¼ã‚¸ãƒ§ãƒ³: 1.0
