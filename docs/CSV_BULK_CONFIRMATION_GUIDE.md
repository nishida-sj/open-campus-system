# CSV一括確定機能 使い方ガイド

## 📋 概要

申込確定管理ページで、CSVファイルを使って複数の申込者を一括で確定できる機能です。
100名規模の申込者でも、Excelで効率的に管理・確定できます。

---

## 🎯 使用シーン

- **大量の申込者を一括確定したい**（50名以上）
- **Excelの強力な検索・フィルター機能を活用したい**
- **特定の条件（学校名、日程など）で絞り込んで確定したい**
- **オフラインで作業してから一括アップロードしたい**

---

## 📝 使い方

### Step 1: CSVテンプレートをダウンロード

1. 申込確定管理ページ（`/admin/confirmations`）にアクセス
2. イベントを選択
3. 「CSV一括確定」セクションの **「テンプレートDL」** ボタンをクリック

**ダウンロードされるCSVファイル**:
```csv
申込者ID,氏名,メールアドレス,確定日程,確定コース,確定
abc-123-def,田中太郎,tanaka@example.com,2025-12-15,工学部体験,
def-456-ghi,佐藤花子,sato@example.com,2025-12-22,医学部体験,
```

### Step 2: Excelで編集

1. ダウンロードしたCSVファイルをExcelで開く
2. **「確定」列に `○` を入力**（確定したい申込者のみ）
3. 必要に応じて **「確定日程」** や **「確定コース」** を編集
4. ファイルを保存（CSV形式のまま）

**編集例**:
```csv
申込者ID,氏名,メールアドレス,確定日程,確定コース,確定
abc-123-def,田中太郎,tanaka@example.com,2025-12-15,工学部体験,○
def-456-ghi,佐藤花子,sato@example.com,2025-12-22,医学部体験,○
ghi-789-jkl,鈴木一郎,suzuki@example.com,2025-12-15,工学部体験,
```
↑ 田中さんと佐藤さんのみ確定される

### Step 3: CSVアップロード

1. 申込確定管理ページに戻る
2. **「CSVアップロード」** ボタンをクリック
3. ダイアログで **「CSVファイルを選択」** から編集したファイルを選択
4. **「アップロードして確定」** ボタンをクリック

### Step 4: 処理結果を確認

処理完了後、以下が表示されます:
- ✅ **成功**: 確定に成功した件数
- ❌ **失敗**: エラーが発生した件数
- ⏭️ **スキップ**: 確定フラグがない行の件数

エラーがある場合は、詳細が表示されるので修正して再度アップロードしてください。

---

## 📊 CSVフォーマット詳細

### ヘッダー行（必須）
```
申込者ID,氏名,メールアドレス,確定日程,確定コース,確定
```

### データ列の説明

| 列名 | 必須 | 説明 | 編集可能 |
|------|------|------|----------|
| 申込者ID | ✅ | システムで自動生成されたID | ❌ 編集不可 |
| 氏名 | - | 申込者の氏名（参照用） | ❌ 編集不可 |
| メールアドレス | - | 申込者のメールアドレス（参照用） | ❌ 編集不可 |
| 確定日程 | ✅ | 確定する日程 | ✅ 編集可能 |
| 確定コース | - | 確定するコース | ✅ 編集可能 |
| 確定 | ✅ | `○` を入力すると確定対象 | ✅ 編集必須 |

### 日付フォーマット

以下の形式に対応しています:
- `2025-12-15` (推奨)
- `2025/12/15`
- `2025年12月15日`

---

## ✅ 確定のルール

### 1. 確定フラグ
- **「確定」列に `○` が入力されている行のみ**が処理されます
- 空欄や `○` 以外の文字は無視されます（スキップ）

### 2. 日程の検証
- **申込者が選択した日程のみ**確定できます
- 選択していない日程を指定するとエラーになります

### 3. 複数日参加の制御
- **イベント設定で複数日参加が許可されている場合**:
  - 複数の日程を確定できます
- **単一日のみ参加可能な場合**:
  - 既に別の日程が確定されている申込者はエラーになります

### 4. 既存確定の更新
- **既に確定済みの日程**がある場合:
  - コース情報のみ更新されます
  - カウントは変更されません

---

## ⚠️ エラーの種類と対処法

### エラー1: 申込者が見つかりません
**原因**: 申込者IDが間違っている、または削除されている
**対処**: テンプレートを再ダウンロードして最新のデータを使用

### エラー2: 確定日程が見つかりません
**原因**:
- 日付フォーマットが間違っている
- このイベントに存在しない日程を指定している

**対処**:
- 日付形式を `2025-12-15` に修正
- イベントに登録されている日程を確認

### エラー3: 選択されていない日程です
**原因**: 申込者が選択していない日程を確定しようとしている
**対処**: 申込者が実際に選択した日程を確認して指定

### エラー4: 複数日参加が許可されていません
**原因**: 単一日のみ参加可能なイベントで、既に別の日程が確定されている
**対処**:
- 既存の確定を解除してから再度確定
- または、確定日程を既存の確定と同じ日程に変更

### エラー5: CSVヘッダーが正しくありません
**原因**: CSVのヘッダー行が改変されている
**対処**: テンプレートを再ダウンロードしてヘッダー行を修正

---

## 💡 効率的な使い方のコツ

### 1. Excelのフィルター機能を活用
```
1. ヘッダー行を選択
2. 「データ」→「フィルター」を有効化
3. 学校名や日程でフィルタリング
4. 該当行の「確定」列に一括で○を入力
```

### 2. 条件付き書式で視覚化
```
1. 「確定」列に○がある行を色分け
2. 確定済みの行を一目で識別
3. 入力漏れを防止
```

### 3. 複数回に分けて処理
```
1回目: 第1希望の日程で確定（50名）
2回目: 第2希望の日程で確定（30名）
3回目: 残りの申込者を個別に確定（20名）
```

### 4. バックアップを取る
```
編集前のCSVファイルを別名で保存
エラーが発生した場合に元に戻せる
```

---

## 🔒 セキュリティとデータ整合性

### 安全な処理
- **トランザクション処理**: エラーが発生しても部分的に確定される（行ごとに処理）
- **バリデーション**: データベースレベルで整合性をチェック
- **ロールバック不要**: 失敗した行のみスキップ、成功した行は確定される

### データ保護
- **申込者IDは編集不可**: 誤った申込者を確定するリスクを回避
- **日程の検証**: 選択していない日程は確定できない
- **定員チェック**: 定員を超える確定は自動的にカウントされる（手動で管理）

---

## 📈 サンプルシナリオ

### シナリオ1: 特定の学校の申込者を一括確定

1. CSVテンプレートをダウンロード
2. Excelで開き、学校名でフィルター（例: 〇〇高校）
3. フィルターされた全行の「確定」列に `○` を入力
4. フィルターを解除してファイルを保存
5. CSVアップロードで一括確定

**結果**: 〇〇高校の申込者のみが確定される

### シナリオ2: 第1希望で全員確定

1. CSVテンプレートをダウンロード（第1希望の日程が自動入力される）
2. 全行の「確定」列に `○` を入力（Excelの一括入力機能を使用）
3. ファイルを保存
4. CSVアップロードで一括確定

**結果**: 全申込者が第1希望の日程で確定される

### シナリオ3: 定員調整しながら確定

1. CSVテンプレートをダウンロード
2. 日程ごとに定員を確認しながら、「確定日程」を調整
3. 定員に達した日程は別の日程に変更
4. 「確定」列に `○` を入力
5. CSVアップロードで一括確定

**結果**: 定員バランスを取りながら確定される

---

## 🆘 トラブルシューティング

### Q1: CSVファイルが文字化けする
**A**: Excelで開く際に以下を試してください
1. Excelで「データ」→「テキストファイル」から開く
2. エンコーディングを「UTF-8」に指定
3. または、LibreOffice Calcを使用

### Q2: アップロード後に何も起こらない
**A**:
1. ブラウザのコンソールでエラーを確認
2. CSVファイルが正しい形式か確認
3. 「確定」列に `○` が入力されているか確認

### Q3: 一部の申込者がエラーになる
**A**:
1. エラー詳細を確認
2. 該当行のみを修正
3. 再度CSVアップロード（成功した行はスキップされる）

### Q4: 確定件数が意図した数と違う
**A**:
1. 「確定」列の `○` が全角か確認（半角は無効）
2. スキップされた行数を確認
3. エラー詳細を確認

---

## 📚 関連ドキュメント

- [申込確定管理の使い方](./CONFIRMATION_MANAGEMENT.md)
- [データベース構造](./FEATURES.md#データベース構造)
- [API仕様](./API_REFERENCE.md)

---

## 🔄 更新履歴

| 日付 | バージョン | 変更内容 |
|------|------------|----------|
| 2025-11-14 | 1.0.0 | CSV一括確定機能リリース |

---

**最終更新**: 2025年11月14日
**機能ステータス**: ✅ 本番利用可能
