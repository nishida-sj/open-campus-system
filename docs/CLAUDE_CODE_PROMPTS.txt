# Claude Code 実行プロンプト - オープンキャンパス申込管理システム

## 🎯 現在の状況
プロジェクトの初期セットアップ（Step 1-7）が完了しました。
次はSupabaseのセットアップとデータベース構築を行います。

---

## 📋 Phase 1: Supabaseセットアップ

### プロンプト1-1: Supabaseアカウント作成のガイド
```
Supabaseのアカウントをまだ作成していません。
以下の情報を教えてください：

1. Supabaseアカウントの作成手順（スクリーンショット付きで詳しく）
2. プロジェクトの作成方法
3. 東京リージョンの選択方法
4. API キーの取得場所と取得方法
5. セキュリティ上の注意点

完了後、以下の情報を.env.localに追加する必要があります：
- NEXT_PUBLIC_SUPABASE_URL
- NEXT_PUBLIC_SUPABASE_ANON_KEY
- SUPABASE_SERVICE_ROLE_KEY
```

---

### プロンプト1-2: データベーステーブルの作成
```
Supabaseプロジェクトが作成できました。
以下のテーブルを作成するSQLを実行したいです：

必要なテーブル：
1. open_campus_dates - 開催日程マスタ
2. courses - コース・学科マスタ
3. applicants - 申込者情報
4. application_logs - 申込ログ（監査用）

要件：
- PostgreSQLの標準的な構文を使用
- UUIDを主キーとして使用
- タイムスタンプは WITH TIME ZONE
- 外部キー制約を適切に設定
- インデックスを最適化
- サンプルデータ（コース4つ、開催日程4つ）を挿入

特に以下のカラムが重要です：
【applicantsテーブル】
- 基本情報: name, kana_name, email, phone
- 学校情報: school_name, school_type, grade, graduation_year
- 住所: postal_code, prefecture, address
- 保護者: guardian_name, guardian_phone, guardian_attendance
- 希望: interested_course_id (courses.idへの外部キー), visit_date (open_campus_dates.dateへの外部キー)
- LINE連携: token, token_expires_at, line_user_id
- ステータス: status (pending/completed/expired)

また、以下の関数も作成してください：
- increment_visit_count(visit_date DATE) - 申込数を増やす関数

完全なSQLスクリプトを提供してください。
```

---

### プロンプト1-3: Supabaseクライアントの動作確認
```
データベーステーブルが作成できました。
lib/supabase.ts の動作確認をしたいです。

以下を実装してください：
1. app/page.tsx を一時的に修正して、Supabase接続テストページを作成
2. coursesテーブルからデータを取得して表示
3. open_campus_datesテーブルからデータを取得して表示
4. 接続成功/失敗を視覚的に確認できるUI

開発サーバーを起動して http://localhost:3000 で確認します。
```

---

## 📋 Phase 2: 申込フォームの実装

### プロンプト2-1: APIエンドポイントの作成
```
申込フォームで使用するAPIエンドポイントを作成してください。

【必要なAPI】
1. app/api/courses/route.ts
   - GETメソッド
   - coursesテーブルから有効なコース一覧を取得
   - display_order順にソート
   - エラーハンドリング

2. app/api/open-campus-dates/route.ts
   - GETメソッド
   - open_campus_datesテーブルから開催日程を取得
   - 条件: is_active=true AND date >= 今日
   - date順にソート
   - 残席数も計算して返す

3. app/api/apply/route.ts
   - POSTメソッド
   - 申込処理を実行
   - バリデーション（lib/validation.tsのスキーマを使用）
   - 重複チェック（email + visit_date）
   - 定員チェック
   - トークン生成（crypto.randomBytes使用、30分有効期限）
   - applicantsテーブルに挿入
   - application_logsに記録
   - increment_visit_count関数を呼び出し
   - エラーハンドリング

すべてのAPIでTypeScript型を正しく使用し、
Next.js 15のApp Router形式で実装してください。
```

---

### プロンプト2-2: 申込フォーム画面の作成
```
ユーザー向けの申込フォーム画面を作成してください。

ファイル: app/apply/page.tsx

【要件】
1. レスポンシブデザイン（Tailwind CSS使用）
2. 以下の入力フィールド：
   - 氏名（必須）
   - ふりがな
   - メールアドレス（必須）
   - 電話番号（必須）
   - 学校名（必須）
   - 学校種別（選択: 中学校/高校/その他）
   - 学年（必須、選択式）
   - 希望コース（APIから取得、選択式）
   - 参加希望日（APIから取得、選択式、残席数表示）
   - 保護者同伴（チェックボックス）
   - 保護者氏名（条件付き表示）
   - 保護者電話番号（条件付き表示）
   - 備考

3. バリデーション
   - クライアントサイドでリアルタイム検証
   - エラーメッセージを各フィールドの下に表示

4. 送信処理
   - /api/apply にPOSTリクエスト
   - ローディング状態の表示
   - エラー時は画面上部にエラーメッセージ
   - 成功時はLINE友達登録画面に遷移

5. LINE友達登録画面
   - 申込完了メッセージ
   - LINE友達登録ボタン（トークン付きURL）
   - 有効期限の表示（30分）
   - 視覚的に魅力的なデザイン

モダンで使いやすいUIを実装してください。
```

---

## 📋 Phase 3: LINE連携の実装

### プロンプト3-1: LINE Webhook APIの作成
```
LINE Messaging APIのWebhook処理を実装してください。

ファイル: app/api/line/webhook/route.ts

【要件】
1. POSTメソッドで実装
2. LINE署名検証（@line/bot-sdk使用）
3. イベントタイプ別の処理：
   - followイベント（友達追加時）:
     * URLパラメータからトークンを取得
     * トークンの有効性確認
     * 有効期限チェック
     * applicantsテーブルのline_user_idを更新
     * statusをcompletedに変更
     * application_logsに記録
     * 申込完了メッセージを送信（氏名、参加日、学校名を含む）
   - messageイベント（メッセージ受信時）:
     * 簡易的な自動応答（キーワード: 場所、アクセス、日程など）

4. エラーハンドリング
   - トークンが見つからない場合
   - 有効期限切れの場合
   - その他のエラー

5. LINE クライアントの設定
   - 環境変数からChannel Access TokenとChannel Secretを使用

完全なWebhook処理を実装してください。
```

---

### プロンプト3-2: LINE Developers設定ガイド
```
LINE DevelopersコンソールでWebhookを設定する手順を教えてください。

現在の状況：
- LINEビジネスアカウントは作成済み
- Channel Access TokenとChannel Secretは取得済み
- ローカル開発中（http://localhost:3000）

知りたいこと：
1. Webhook URLの設定方法
2. ローカル開発時のWebhook テスト方法（ngrokなどのツール使用）
3. 友達追加時のパラメータ設定
4. LINE公式アカウントの基本設定（応答メッセージの無効化など）
5. テスト方法

詳しい手順を教えてください。
```

---

## 📋 Phase 4: 管理画面の実装

### プロンプト4-1: 管理画面のログイン機能
```
管理画面のログイン機能を実装してください。

ファイル: app/admin/login/page.tsx

【要件】
1. シンプルなパスワード認証
   - 環境変数 NEXT_PUBLIC_ADMIN_PASSWORD と照合
   - sessionStorageに認証状態を保存
2. ログイン成功後は /admin/dashboard にリダイレクト
3. エラー表示
4. モダンなUIデザイン

※注意: これは簡易的な実装です。本番環境では適切な認証システム（NextAuth.jsなど）を使用すべきです。
```

---

### プロンプト4-2: 管理ダッシュボードの作成
```
管理者向けダッシュボード画面を実装してください。

ファイル: app/admin/dashboard/page.tsx
必要なAPI: app/api/admin/applicants/route.ts, app/api/admin/dates/route.ts

【ダッシュボードの機能】
1. 統計カード
   - 総申込数
   - 完了数（LINE登録済み）
   - 未完了数（LINE未登録）

2. 日程別申込状況
   - 各開催日の申込数/定員
   - 進捗バー
   - 受付状況（受付中/満員）

3. 申込者一覧テーブル
   - 氏名、学校名、学年、参加日、LINE登録状況、申込日時
   - ソート機能
   - ステータスバッジ（色分け）

4. CSVエクスポート機能
   - すべての申込者データをCSV形式でダウンロード
   - BOM付きUTF-8（Excelで文字化けしない）
   - 日本語ヘッダー

5. 認証チェック
   - sessionStorageの認証状態を確認
   - 未認証時はログイン画面にリダイレクト

レスポンシブでモダンなデザインを実装してください。
```

---

## 📋 Phase 5: デプロイ準備

### プロンプト5-1: 本番環境用の設定確認
```
本番デプロイ前に、以下を確認・実装してください：

1. 環境変数のチェック
   - 必要な環境変数がすべて設定されているか確認
   - .env.example ファイルの作成（値は空）

2. セキュリティチェック
   - CORS設定の確認
   - Rate limiting の必要性
   - SQLインジェクション対策の確認

3. エラーハンドリングの確認
   - すべてのAPIエンドポイントで適切なエラーハンドリング
   - ユーザーフレンドリーなエラーメッセージ

4. パフォーマンス最適化
   - 画像の最適化
   - 不要なログの削除
   - キャッシュ戦略

5. README.md の作成
   - プロジェクト概要
   - セットアップ手順
   - 環境変数の説明
   - デプロイ手順

チェックリストとREADMEを作成してください。
```

---

### プロンプト5-2: Vercelデプロイガイド
```
Vercelアカウントをまだ作成していません。
デプロイの準備が整ったので、以下を教えてください：

1. Vercelアカウントの作成手順
2. GitHubリポジトリとの連携方法
3. プロジェクトのインポート手順
4. 環境変数の設定方法（Vercelダッシュボード）
5. デプロイの実行
6. カスタムドメインの設定（オプション）
7. デプロイ後の動作確認方法

特に、LINE Webhook URLをVercelの本番URLに更新する手順も含めてください。

詳しい手順をステップバイステップで教えてください。
```

---

## 🔧 トラブルシューティング用プロンプト

### デバッグ用プロンプト
```
以下のエラーが発生しています：

[エラーメッセージをここに貼り付け]

発生箇所：[ファイル名と行数]
実行した操作：[操作内容]

原因を特定し、解決方法を提案してください。
```

---

### コードレビュー依頼プロンプト
```
以下のコードをレビューしてください：

[コードを貼り付け]

レビュー観点：
1. セキュリティ上の問題
2. パフォーマンスの改善点
3. コードの可読性
4. ベストプラクティスとの比較
5. エラーハンドリングの妥当性

改善提案をお願いします。
```

---

## 📝 使い方

1. 各Phaseのプロンプトを順番に実行
2. 実装が完了したら次のプロンプトへ
3. エラーが発生したらトラブルシューティング用プロンプトを使用
4. 完成したコードはGitにコミット

---

## ⚠️ 重要な注意事項

1. **Supabaseアカウント作成**: Phase 1の最初に必要
2. **Vercelアカウント作成**: Phase 5で必要
3. **環境変数の管理**: 絶対にGitにコミットしない
4. **定期的なコミット**: 各機能実装後にGitにコミット
5. **バックアップ**: 外付けSSDなので、GitHubへの定期的なプッシュを忘れない

---

作成日: 2025年11月9日
プロジェクト: オープンキャンパス申込管理システム
