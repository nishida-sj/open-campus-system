# AI機能改修完了レポート

## 実装概要

オープンキャンパス管理システムのAI設定機能を大幅に改修しました。固定項目、カスタム項目、イベント情報の自動取得を組み合わせた動的プロンプト生成システムを実装しました。

## 実装日

2025年12月2日

## 変更ファイル一覧

### 新規作成

1. **`docs/database_migration_ai_prompts.sql`**
   - AI設定用の新しいデータベーススキーマ
   - 5つの新しい設定キーを追加

2. **`docs/SUPABASE_AI_MIGRATION.md`**
   - データベースマイグレーション手順書
   - Supabaseダッシュボードでの実行手順

3. **`app/api/admin/ai-prompt/route.ts`** (完全新規)
   - GET: 動的プロンプト生成API
   - POST: AI設定更新API

### 完全書き換え

4. **`app/admin/ai-settings/page.tsx`**
   - 3タブインターフェースで完全再設計
   - 固定項目タブ、カスタム項目タブ、プレビュータブ

### 修正

5. **`lib/ai-response.ts`**
   - 静的プロンプトから動的プロンプトへ移行
   - キャッシュ機構追加（5分間有効）
   - フォールバック処理実装

## 機能詳細

### 1. 固定項目（4項目）

管理画面から編集可能な4つの固定項目：

- **学校情報** (`prompt_school_info`)
  - 学校の基本情報、特徴、コース情報など

- **アクセス** (`prompt_access`)
  - 学校へのアクセス方法、最寄り駅、駐車場情報など

- **回答が出来なかった際に記述する内容** (`prompt_unable_response`)
  - AIが回答できない場合のメッセージ

- **必ず最後に記述する内容** (`prompt_closing_message`)
  - すべての回答の最後に追加されるメッセージ

### 2. カスタム項目（無制限）

管理者が自由に追加・編集・削除できる項目：

- 項目名とコンテンツを自由に設定
- ドラッグ&ドロップで順序変更
- インライン編集機能
- 表示/非表示の切り替え

### 3. イベント自動生成

以下の条件を満たすイベントを自動的にプロンプトに含める：

- `is_active = true`（有効なイベント）
- `display_end_date >= 今日の日付`（表示期限内）

各イベントの以下の情報を含む：

- イベント名
- 説明（管理用）
- 開催日程（日付、定員、残り人数）
- コース情報（コース名、説明）

## 技術仕様

### API仕様

#### GET `/api/admin/ai-prompt`

**説明**: 最終的なシステムプロンプトを動的に生成

**レスポンス**:
```json
{
  "success": true,
  "prompt": "最終的なシステムプロンプト（全項目を組み合わせたもの）",
  "parts": {
    "school_info": "学校情報の内容",
    "access": "アクセス情報の内容",
    "unable_response": "回答不可時の内容",
    "closing_message": "締めメッセージの内容",
    "custom_items": [
      {
        "id": "uuid",
        "name": "項目名",
        "content": "内容",
        "order": 1
      }
    ],
    "events": [
      {
        "id": 1,
        "name": "イベント名",
        "description": "説明",
        "dates": [...],
        "courses": [...]
      }
    ],
    "event_prompts": "イベント情報のプロンプトテキスト"
  }
}
```

#### POST `/api/admin/ai-prompt`

**説明**: AI設定を更新

**リクエスト**:
```json
{
  "setting_key": "prompt_school_info",
  "setting_value": "更新内容"
}
```

**レスポンス**:
```json
{
  "success": true
}
```

### キャッシュ仕様

`lib/ai-response.ts`にプロンプトキャッシュを実装：

- **キャッシュ期間**: 5分間
- **目的**: API呼び出し回数削減、パフォーマンス向上
- **キャッシュクリア**: `clearPromptCache()`関数で手動クリア可能

### フォールバック処理

APIエラー時の対応：

1. キャッシュが有効な場合 → キャッシュから返す
2. API呼び出し失敗 → 基本的なプロンプトで動作継続
3. エラーログを記録

## 環境変数

### 必要な環境変数

**ローカル開発** (`.env.local`):
```bash
NEXT_PUBLIC_BASE_URL=http://localhost:3000
```

**本番環境** (Vercel):
```bash
NEXT_PUBLIC_BASE_URL=https://open-campus-system.vercel.app
```

## デプロイ手順

### 1. データベースマイグレーション

✅ **完了済み** - ユーザーが既に実行

1. Supabaseダッシュボードにログイン
2. SQL Editorで`docs/database_migration_ai_prompts.sql`を実行
3. 確認クエリで新しい設定キーが作成されたことを確認

### 2. Vercel環境変数設定

Vercelダッシュボードで以下を設定：

1. プロジェクト設定 → Environment Variables
2. `NEXT_PUBLIC_BASE_URL`を追加
   - 値: `https://open-campus-system.vercel.app`
   - すべての環境（Production, Preview, Development）にチェック

### 3. デプロイ

```bash
git add .
git commit -m "Feat: Complete AI settings renovation with dynamic prompt system"
git push origin main
```

Vercelが自動的にデプロイします。

## テスト手順

### 1. AI設定画面のテスト

1. 管理画面にログイン
2. サイドバーから「AI設定」をクリック
3. **固定項目タブ**:
   - 各項目にテキストを入力
   - 「保存」ボタンをクリック
   - 成功メッセージを確認
4. **カスタム項目タブ**:
   - 「新規追加」ボタンをクリック
   - 項目名とコンテンツを入力して保存
   - 編集、削除、順序変更をテスト
5. **プレビュータブ**:
   - 有効なイベントが表示されることを確認
   - 最終プロンプトが正しく生成されることを確認

### 2. LINE連携でのテスト

1. LINE公式アカウントを友だち追加
2. オープンキャンパスに申し込み
3. トークンを送信して連携完了
4. 学校に関する質問を送信
5. AIが新しいプロンプトに基づいて回答することを確認

### 3. キャッシュのテスト

1. AI設定を変更
2. 最大5分待機
3. LINE連携で質問を送信
4. 新しい設定が反映されることを確認

### 4. イベント自動生成のテスト

1. イベント管理画面で新しいイベントを作成
2. `display_end_date`を未来の日付に設定
3. `is_active`をtrueに設定
4. AI設定のプレビュータブで確認
5. イベント情報が自動的に含まれることを確認

## ファイル構造

```
open-campus-system/
├── app/
│   ├── admin/
│   │   └── ai-settings/
│   │       └── page.tsx          (完全書き換え)
│   └── api/
│       └── admin/
│           └── ai-prompt/
│               └── route.ts       (新規作成)
├── lib/
│   └── ai-response.ts            (修正)
├── docs/
│   ├── database_migration_ai_prompts.sql  (新規作成)
│   ├── SUPABASE_AI_MIGRATION.md          (新規作成)
│   └── AI_FEATURE_IMPLEMENTATION.md      (このファイル)
└── .env.local                    (環境変数追加必要)
```

## データベーススキーマ

### `ai_settings`テーブル

新しく追加された設定キー：

| setting_key | 説明 | データ型 |
|-------------|------|---------|
| `prompt_school_info` | 学校情報 | TEXT |
| `prompt_access` | アクセス情報 | TEXT |
| `prompt_unable_response` | 回答不可時のメッセージ | TEXT |
| `prompt_closing_message` | 締めメッセージ | TEXT |
| `prompt_custom_items` | カスタム項目（JSON配列） | TEXT (JSON) |

### カスタム項目のJSON構造

```json
[
  {
    "id": "uuid-string",
    "name": "項目名",
    "content": "項目の内容",
    "order": 1
  }
]
```

## 主な改善点

1. **動的プロンプト生成**
   - 静的ファイルから動的API取得へ移行
   - リアルタイムでプロンプト内容を変更可能

2. **イベント情報の自動連携**
   - イベント管理画面の情報が自動的にAIプロンプトに反映
   - 開催日程、定員、残り人数が常に最新

3. **柔軟なカスタマイズ**
   - 無制限のカスタム項目追加
   - ドラッグ&ドロップで順序変更
   - インライン編集で効率的な管理

4. **パフォーマンス最適化**
   - 5分間のキャッシュでAPI呼び出し削減
   - フォールバック処理でシステム安定性向上

5. **管理者フレンドリー**
   - 3タブインターフェースで見やすい画面
   - リアルタイムプレビュー
   - 保存状態の視覚的フィードバック

## 既知の制限事項

1. **キャッシュ期間**
   - AI設定変更後、最大5分間は古いプロンプトが使用される
   - 即座に反映が必要な場合はサーバー再起動が必要

2. **環境変数**
   - `NEXT_PUBLIC_BASE_URL`が未設定の場合、localhostにフォールバック
   - 本番環境では必ず設定すること

3. **イベント情報の更新タイミング**
   - イベント情報は最大5分間キャッシュされる
   - イベント作成・編集後、即座には反映されない可能性

## 今後の拡張案

1. **リアルタイム反映**
   - WebSocketでプロンプト更新を即座に反映
   - 管理画面で「即座に反映」ボタンを追加

2. **バージョン管理**
   - プロンプトの変更履歴を保存
   - 以前のバージョンにロールバック可能

3. **A/Bテスト**
   - 複数のプロンプトバージョンでテスト
   - 効果測定とレポート機能

4. **多言語対応**
   - 日本語・英語・中国語などの多言語プロンプト
   - 自動翻訳機能

## トラブルシューティング

### プロンプトが反映されない

**原因**: キャッシュが有効な間は古いプロンプトが使用される

**解決策**:
1. 5分待機
2. または、サーバーを再起動してキャッシュをクリア

### APIエラーが発生する

**原因**: `NEXT_PUBLIC_BASE_URL`が未設定

**解決策**:
1. `.env.local`に環境変数を追加
2. Vercelの環境変数を確認
3. サーバーを再起動

### イベント情報が表示されない

**原因**: `display_end_date`が過去の日付、または`is_active`がfalse

**解決策**:
1. イベント管理画面で設定を確認
2. `display_end_date`を未来の日付に変更
3. `is_active`をtrueに設定

## まとめ

AI機能の改修により、以下を実現しました：

✅ 動的プロンプト生成システム
✅ イベント情報の自動連携
✅ 柔軟なカスタマイズ機能
✅ 管理者フレンドリーなUI
✅ パフォーマンス最適化（キャッシュ）
✅ エラーハンドリングとフォールバック

この改修により、管理者は簡単にAIの応答内容をカスタマイズでき、イベント情報が常に最新の状態で提供されるようになりました。
