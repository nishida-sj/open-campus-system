# オープンキャンパス管理システム - 機能一覧

## 目次

1. [システム概要](#システム概要)
2. [申込者向け機能](#申込者向け機能)
3. [管理者向け機能](#管理者向け機能)
4. [通知機能](#通知機能)
5. [データベース構造](#データベース構造)

---

## システム概要

オープンキャンパスの申込受付から参加確定、通知送信までを一元管理するWebアプリケーション。

### 技術スタック

- **フロントエンド**: Next.js 16 (App Router), React 19, TypeScript, Tailwind CSS
- **バックエンド**: Next.js API Routes
- **データベース**: Supabase (PostgreSQL)
- **デプロイ**: Vercel
- **外部連携**: LINE Messaging API, Nodemailer (SMTP)

### システム構成

```
申込者 → Web申込フォーム → Supabase DB
                                ↓
管理者 → 管理画面 → 申込確認・確定 → LINE/メール通知
```

---

## 申込者向け機能

### 1. イベント一覧表示

**URL**: `/` (トップページ)

**機能**:
- 公開中のオープンキャンパスイベント一覧を表示
- イベント名、概要、開催日程を確認可能
- 表示終了日を過ぎたイベントは自動的に非表示

**表示情報**:
- イベント名
- イベント概要（申込者向け説明文）
- 開催日程一覧
- 各日程の定員と現在の申込状況

### 2. 申込フォーム

**URL**: `/apply`

**機能**:
- オープンキャンパスへの参加申込
- 複数日程選択可能（イベント設定による）
- コース選択機能（コース設定がある場合）
- LINE連携によるリアルタイム通知

**入力項目**:
- **基本情報**:
  - 氏名（必須）
  - ふりがな（任意）
  - メールアドレス（必須）
  - 電話番号（必須）
- **学校情報**:
  - 学校名（必須）
  - 学校種別（高校/中学校/その他、任意）
  - 学年（必須）
- **参加情報**:
  - イベント選択（必須）
  - 参加希望日程（必須、複数選択可）
  - 参加コース（コース設定がある場合、必須）

**バリデーション**:
- メールアドレス形式チェック
- 電話番号形式チェック
- 定員超過チェック
- 必須項目入力チェック

### 3. LINE連携機能

**機能**:
- 申込時にLINE友だち追加QRコードを表示
- LINE連携により以下の通知を受信可能:
  - 申込受付完了通知
  - 参加確定通知（管理者が確定操作後）

**LINE通知内容**:
- イベント名
- 参加日時
- 参加コース
- 確定者案内メッセージ（管理者が設定した場合）

### 4. 申込完了画面

**URL**: `/apply/success`

**表示内容**:
- 申込完了メッセージ
- LINE友だち追加QRコード
- 今後の流れの説明
- 注意事項

---

## 管理者向け機能

### 1. 管理者ログイン

**URL**: `/admin/login`

**機能**:
- パスワード認証によるログイン
- セッションストレージによる認証状態管理
- 未認証時の自動リダイレクト

**認証情報**:
- パスワードは環境変数 `ADMIN_PASSWORD` で管理

### 2. ダッシュボード

**URL**: `/admin/dashboard`

**機能**:
- システム全体の概要確認
- 各種管理機能へのナビゲーション

**表示情報**:
- 登録イベント数
- 総申込者数
- アクティブなイベント一覧
- 最近の申込状況

**アクション**:
- イベント管理画面へ遷移
- 申込確定管理画面へ遷移
- 確定者管理画面へ遷移
- メール設定画面へ遷移

### 3. イベント管理

**URL**: `/admin/events`

**機能**:
- オープンキャンパスイベントの作成・編集・削除
- 開催日程の設定
- コース設定（体験授業など）
- イベントの公開/非公開切り替え

#### イベント作成

**設定項目**:

**基本情報**:
- **イベント名**（必須）: 表示されるイベント名
- **説明（管理用）**（任意）: 管理者メモ
- **イベント概要（申込者向け）**（任意）: 申込者に表示される詳細説明
- **確定者案内メッセージ**（任意）: LINE/メール通知時に追加されるメッセージ
  - 持ち物、集合場所、注意事項などを記載
  - 確定通知送信時に自動的に含まれる
- **表示終了日**（任意）: この日を過ぎるとイベント一覧に表示されなくなる
- **アクティブ状態**: 公開/非公開の切り替え

**日程設定**:
- **開催日**（必須、複数設定可）
- **定員**（各日程ごとに設定、必須）
- 日程の追加・削除

**詳細設定**:
- **複数日程選択許可**: 申込者が複数の日程を選択できるか
- **最大選択可能日程数**: 複数選択時の上限

**コース設定**（任意）:
- **コース名**（必須）
- **コース説明**（任意）
- **定員**（任意）
- **表示順序**
- **適用日程**: どの日程でこのコースを選択可能にするか
- コースの追加・削除・並び替え

#### イベント編集

**URL**: `/admin/events/[id]/edit`

**機能**:
- 既存イベントの情報変更
- 申込者がいる場合は日程・コースの変更不可（データ整合性保護）
- 基本情報（名前、説明、確定者案内メッセージなど）はいつでも変更可能

### 4. 申込確定管理

**URL**: `/admin/confirmations`

**機能**:
- 申込者の参加日程・コースを確定
- 日程ごとの申込状況確認
- 定員管理

**表示情報**:
- イベント選択
- 日程フィルター
- 定員情報（定員X名 / 現在Y名 / 残りZ名）
- 未確定申込者一覧:
  - 氏名
  - 学校名
  - 学年
  - 希望日程（複数の場合は全て表示）
  - 確定状態

**アクション**:
- **参加確定**: 申込者の参加日程とコースを確定
  - 確定する日程を選択
  - コースを選択（コース設定がある場合）
  - 確定時に定員カウントが自動更新
- **確定解除**: 確定済みの申込を未確定に戻す
  - 定員カウントが自動で減算される

**自動処理**:
- 確定/解除時の定員カウント自動更新
- 重複確定の防止
- 定員超過チェック

### 5. 確定者管理

**URL**: `/admin/confirmed-list`

**機能**:
- 参加確定済み申込者の一覧表示
- LINE/メール通知の送信
- CSV出力

**フィルター機能**:
- イベント選択
- 日程フィルター（全日程 / 特定日程）

**表示情報**:
- チェックボックス（一括選択用）
- 氏名・ふりがな
- メールアドレス
- 学校名・学校種別
- 学年
- 参加日
- 参加コース
- LINE送信日（送信済みの場合）
- メール送信日（送信済みの場合）

**アクション**:

1. **LINE通知送信**:
   - 選択した確定者にLINE通知を一括送信
   - LINE連携済みの申込者のみに送信
   - 送信結果を個別に表示
   - 送信履歴を自動記録

2. **メール通知送信**:
   - 選択した確定者にメール通知を一括送信
   - 全ての確定者に送信可能
   - 送信結果を個別に表示
   - 送信履歴を自動記録

3. **CSV出力**:
   - フィルター条件に応じた確定者リストをCSV形式でダウンロード
   - Excel対応（BOM付きUTF-8）
   - ファイル名: `確定者一覧_[イベント名]_[日程]_[日付].csv`

**CSV出力項目**:
- 氏名
- よみがな
- 学校名
- 学校種別
- 学年
- 参加日
- コース
- メールアドレス
- 電話番号
- 確定日時

### 6. メールサーバ設定

**URL**: `/admin/email-settings`

**機能**:
- SMTPサーバー設定の登録・更新
- テストメール送信機能

**設定項目**:
- **SMTPホスト**（必須）: 例) smtp.gmail.com
- **SMTPポート**（必須）: 587 (TLS) または 465 (SSL)
- **SMTPユーザー名**（必須）: メールアドレスまたはユーザー名
- **SMTPパスワード**（必須）:
  - Gmailの場合: アプリパスワード
  - その他: SMTPパスワード
- **送信元メールアドレス**（必須）
- **送信元名**（任意）: 例) オープンキャンパス事務局
- **TLS/STARTTLS使用**: 推奨

**テストメール機能**:
- 設定保存後、テスト送信が可能
- 任意のメールアドレスに送信して設定確認

**Gmail設定例**:
```
SMTPホスト: smtp.gmail.com
SMTPポート: 587
SMTPユーザー名: your-email@gmail.com
SMTPパスワード: アプリパスワード（16文字）
送信元メールアドレス: your-email@gmail.com
TLS使用: ON
```

---

## 通知機能

### 1. LINE通知

**送信タイミング**:
- 管理者が確定者管理画面から送信ボタンをクリック

**通知内容**:
```
【参加確定のお知らせ】

〇〇 様

オープンキャンパスへのお申し込みが確定しました。

■ イベント名
〇〇オープンキャンパス

■ 参加日時
2025年4月15日(火)

■ 参加コース
工学部体験コース

■ 当日のご案内（※イベント設定で入力されている場合）
持ち物: 筆記用具、上履き
集合場所: 正門エントランス
開始時間の10分前にお越しください

当日お会いできることを楽しみにしております。

※このメッセージは自動送信されています。
```

**送信条件**:
- LINE連携済みの申込者のみ
- 参加確定済みの申込者のみ

**送信履歴**:
- データベースに自動記録
- 確定者一覧画面で送信日時を確認可能

### 2. メール通知

**送信タイミング**:
- 管理者が確定者管理画面から送信ボタンをクリック

**通知内容**:
- 件名: `【参加確定】オープンキャンパスのお知らせ - [イベント名]`
- HTML形式とテキスト形式の両方で送信
- LINE通知と同様の内容
- 確定者案内メッセージを含む（設定されている場合）

**HTML メール**:
- 見やすいレイアウト
- カラフルなデザイン
- グレー背景のボックスで情報を整理

**テキストメール**:
- プレーンテキスト形式
- メーラーでHTML表示できない場合のフォールバック

**送信条件**:
- メールサーバー設定が登録済み
- 参加確定済みの申込者のみ

**送信履歴**:
- データベースに自動記録
- 確定者一覧画面で送信日時を確認可能
- 送信失敗時はエラーメッセージも記録

---

## データベース構造

### テーブル一覧

#### 1. open_campus_events
イベントマスタテーブル

| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | UUID | 主キー |
| name | VARCHAR(255) | イベント名 |
| description | TEXT | 説明（管理用） |
| overview | TEXT | イベント概要（申込者向け） |
| confirmation_message | TEXT | 確定者案内メッセージ（LINE/メール通知用） |
| display_end_date | DATE | 表示終了日 |
| max_date_selections | INTEGER | 最大選択可能日程数 |
| is_active | BOOLEAN | 公開フラグ |
| allow_multiple_dates | BOOLEAN | 複数日程選択許可 |
| created_at | TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | 更新日時 |

#### 2. open_campus_dates
開催日程テーブル

| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | UUID | 主キー |
| event_id | UUID | イベントID（外部キー） |
| date | DATE | 開催日 |
| capacity | INTEGER | 定員 |
| current_count | INTEGER | 現在の申込数 |
| is_active | BOOLEAN | 有効フラグ |
| created_at | TIMESTAMP | 作成日時 |

#### 3. event_courses
コースマスタテーブル

| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | UUID | 主キー |
| event_id | UUID | イベントID（外部キー） |
| name | VARCHAR(255) | コース名 |
| description | TEXT | コース説明 |
| capacity | INTEGER | 定員（NULL=無制限） |
| display_order | INTEGER | 表示順序 |
| created_at | TIMESTAMP | 作成日時 |

#### 4. course_date_associations
コース・日程関連テーブル

| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | UUID | 主キー |
| course_id | UUID | コースID（外部キー） |
| date_id | UUID | 日程ID（外部キー） |

#### 5. applicants
申込者テーブル

| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | UUID | 主キー |
| name | VARCHAR(255) | 氏名 |
| kana_name | VARCHAR(255) | ふりがな |
| email | VARCHAR(255) | メールアドレス |
| phone | VARCHAR(20) | 電話番号 |
| school_name | VARCHAR(255) | 学校名 |
| school_type | VARCHAR(50) | 学校種別 |
| grade | VARCHAR(50) | 学年 |
| line_user_id | VARCHAR(255) | LINE User ID |
| status | VARCHAR(20) | ステータス（pending/confirmed） |
| confirmed_date_id | UUID | 確定日程ID |
| confirmed_course_id | UUID | 確定コースID |
| confirmed_at | TIMESTAMP | 確定日時 |
| created_at | TIMESTAMP | 申込日時 |

#### 6. applicant_visit_dates
申込者・希望日程関連テーブル

| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | UUID | 主キー |
| applicant_id | UUID | 申込者ID（外部キー） |
| visit_date_id | UUID | 希望日程ID（外部キー） |

#### 7. applicant_courses
申込者・希望コース関連テーブル

| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | UUID | 主キー |
| applicant_id | UUID | 申込者ID（外部キー） |
| course_id | UUID | 希望コースID（外部キー） |
| visit_date_id | UUID | 対応する日程ID（外部キー） |

#### 8. notification_logs
通知履歴テーブル

| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | UUID | 主キー |
| applicant_id | UUID | 申込者ID（外部キー） |
| notification_type | VARCHAR(20) | 通知タイプ（line/email） |
| sent_at | TIMESTAMP | 送信日時 |
| status | VARCHAR(20) | ステータス（success/failed） |
| error_message | TEXT | エラーメッセージ |
| created_at | TIMESTAMP | 作成日時 |

#### 9. email_settings
メールサーバ設定テーブル

| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | UUID | 主キー |
| smtp_host | VARCHAR(255) | SMTPホスト |
| smtp_port | INTEGER | SMTPポート |
| smtp_user | VARCHAR(255) | SMTPユーザー名 |
| smtp_password | TEXT | SMTPパスワード |
| from_email | VARCHAR(255) | 送信元メールアドレス |
| from_name | VARCHAR(255) | 送信元名 |
| use_tls | BOOLEAN | TLS使用フラグ |
| is_active | BOOLEAN | 有効フラグ |
| created_at | TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | 更新日時 |

### データベース関数

#### increment_visit_count
指定された日程の申込カウントを+1する

```sql
CREATE OR REPLACE FUNCTION increment_visit_count(date_id UUID)
RETURNS VOID AS $$
BEGIN
  UPDATE open_campus_dates
  SET current_count = current_count + 1
  WHERE id = date_id;
END;
$$ LANGUAGE plpgsql;
```

#### decrement_visit_count
指定された日程の申込カウントを-1する

```sql
CREATE OR REPLACE FUNCTION decrement_visit_count(date_id UUID)
RETURNS VOID AS $$
BEGIN
  UPDATE open_campus_dates
  SET current_count = GREATEST(current_count - 1, 0)
  WHERE id = date_id;
END;
$$ LANGUAGE plpgsql;
```

---

## セキュリティ機能

### 1. 認証・認可

- **管理画面**: パスワード認証必須
- **セッション管理**: SessionStorage使用
- **未認証アクセス**: 自動的にログイン画面へリダイレクト

### 2. データバリデーション

- **フロントエンド**: React Hook Formでリアルタイムバリデーション
- **バックエンド**: API層で再度バリデーション（二重チェック）
- **データベース**: NOT NULL制約、外部キー制約

### 3. SQLインジェクション対策

- Supabase公式クライアントライブラリ使用
- パラメータ化クエリのみ使用
- 直接SQL文字列連結は使用しない

### 4. XSS対策

- Reactの自動エスケープ機能
- ユーザー入力をHTMLとしてレンダリングしない
- Content Security Policy設定

---

## パフォーマンス最適化

### 1. データベース

- **インデックス**: 外部キー、検索頻度の高いカラムにインデックス設定
- **N+1問題回避**: JOIN または適切なSELECT戦略
- **カウント最適化**: PostgreSQL関数による効率的な集計

### 2. フロントエンド

- **コード分割**: Next.js動的インポート
- **画像最適化**: Next.js Image コンポーネント使用
- **静的生成**: 可能な部分はSSG（Static Site Generation）

### 3. API

- **並列処理**: Promise.allで複数クエリの同時実行
- **キャッシング**: 適切なキャッシュ戦略
- **レスポンス最適化**: 必要なデータのみ取得

---

## エラーハンドリング

### 1. フロントエンド

- **ユーザーフレンドリーなエラーメッセージ**
- **読み込み状態の明示**: ローディングインジケーター
- **フォールバック UI**: エラー時の代替表示

### 2. バックエンド

- **詳細なエラーログ**: console.error で記録
- **適切なHTTPステータスコード**: 400, 404, 500 など
- **エラーレスポンス**: JSON形式で詳細情報を返却

### 3. データベース

- **トランザクション**: データ整合性の保証
- **ロールバック**: エラー時の自動ロールバック
- **制約違反**: 適切なエラーメッセージ

---

## 今後の拡張可能性

### 計画中の機能

1. **申込者マイページ**
   - 申込内容の確認
   - 日程変更リクエスト
   - キャンセル機能

2. **アンケート機能**
   - イベント後のアンケート配信
   - 集計・分析機能

3. **レポート機能**
   - 参加状況の統計グラフ
   - 学校別・学年別集計
   - PDF出力

4. **自動リマインダー**
   - イベント前日の自動通知
   - 確定期限のリマインダー

5. **QRコードチェックイン**
   - 当日の受付QRコード
   - 参加確認機能

詳細は `FUTURE_IMPROVEMENTS.md` を参照してください。

---

## ライセンス

このプロジェクトは MIT License のもとで公開されています。

## サポート

問い合わせ先: [プロジェクト管理者のメールアドレス]

最終更新: 2025年1月
